{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/rfp-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\nimport { createClient, SupabaseClient } from \"@supabase/supabase-js\";\r\n\r\n// ── Supabase Admin Client (service_role 우선, 없으면 anon key 폴백) ──────────\r\nfunction getAdminClient() {\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n    // rfp_announcements는 RLS disabled이므로 anon key로도 INSERT 가능\r\n    const key =\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY &&\r\n            process.env.SUPABASE_SERVICE_ROLE_KEY !== \"your-service-role-key-here\"\r\n            ? process.env.SUPABASE_SERVICE_ROLE_KEY\r\n            : process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n    return createClient(url, key, { auth: { persistSession: false } });\r\n}\r\n\r\n// ── 타입 ─────────────────────────────────────────────────────────────────────\r\nexport type CollMeth = \"API\" | \"RSS\" | \"Static Scraper\" | \"Dynamic Scraper\";\r\n\r\nexport type PublicOrg = {\r\n    id: number;\r\n    org_name: string;\r\n    org_type: string | null;\r\n    homepage_url: string | null;\r\n    rfp_url: string | null;\r\n    coll_meth: CollMeth | null;\r\n    is_active: boolean;\r\n};\r\n\r\nexport type ScrapedAnnouncement = {\r\n    title: string;\r\n    category?: string;\r\n    deadline?: string | null;   // ISO date string\r\n    description?: string | null;\r\n    source_url?: string | null;\r\n};\r\n\r\nexport type ScrapeOrgResult = {\r\n    org_id: number;\r\n    org_name: string;\r\n    status: \"success\" | \"skipped\" | \"error\";\r\n    inserted: number;\r\n    skipped: number;\r\n    error?: string;\r\n};\r\n\r\n// ── unique_key 생성 (단방향 해시 없이 결정적 문자열로 처리) ─────────────────\r\nfunction buildUniqueKey(orgId: number, title: string, deadline: string | null | undefined): string {\r\n    const d = deadline ?? \"no-deadline\";\r\n    // Node.js crypto 없이 간단한 결정적 키 생성 (서버리스 환경 호환)\r\n    return `${orgId}::${title.trim().toLowerCase()}::${d}`;\r\n}\r\n\r\n// ── 정적 스크래퍼 (Cheerio) ──────────────────────────────────────────────────\r\nexport class StaticScraper {\r\n    private readonly userAgent =\r\n        \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\n    async scrape(rfpUrl: string): Promise<ScrapedAnnouncement[]> {\r\n        const html = await this.fetchHtml(rfpUrl);\r\n        const $ = cheerio.load(html);\r\n        const results: ScrapedAnnouncement[] = [];\r\n\r\n        // ── 전략 1: table 기반 목록 ─────────────────────────────────────────\r\n        const tableRows = $(\"table tbody tr, table tr\").toArray();\r\n        if (tableRows.length > 0) {\r\n            for (const row of tableRows) {\r\n                const cells = $(row).find(\"td\");\r\n                if (cells.length < 2) continue;\r\n\r\n                const titleEl = $(row).find(\"td a\").first();\r\n                const title = titleEl.text().trim() || $(cells.get(0)).text().trim();\r\n                if (!title || title.length < 2) continue;\r\n\r\n                const href = titleEl.attr(\"href\");\r\n                const source_url = href\r\n                    ? href.startsWith(\"http\") ? href : new URL(href, rfpUrl).href\r\n                    : null;\r\n\r\n                // 날짜 패턴 찾기 (YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD)\r\n                const rowText = $(row).text();\r\n                const deadline = this.extractDate(rowText);\r\n\r\n                results.push({ title, source_url, deadline, description: null });\r\n            }\r\n        }\r\n\r\n        // ── 전략 2: list item 기반 ──────────────────────────────────────────\r\n        if (results.length === 0) {\r\n            const listItems = $(\r\n                \"ul li a, .list-item a, .bbs-list a, .board-list a, .notice-list a, article a\"\r\n            ).toArray();\r\n\r\n            for (const el of listItems) {\r\n                const title = $(el).text().trim();\r\n                if (!title || title.length < 3) continue;\r\n\r\n                const href = $(el).attr(\"href\");\r\n                const source_url = href\r\n                    ? href.startsWith(\"http\") ? href : new URL(href, rfpUrl).href\r\n                    : null;\r\n\r\n                const parentText = $(el).parent().text();\r\n                const deadline = this.extractDate(parentText);\r\n\r\n                results.push({ title, source_url, deadline, description: null });\r\n            }\r\n        }\r\n\r\n        // ── 전략 3: RSS/Atom feed XML ────────────────────────────────────────\r\n        if (results.length === 0 && (rfpUrl.includes(\"rss\") || rfpUrl.includes(\"feed\") || rfpUrl.includes(\"atom\"))) {\r\n            $(\"item, entry\").each((_, el) => {\r\n                const title = $(el).find(\"title\").text().trim();\r\n                if (!title) return;\r\n\r\n                const source_url = $(el).find(\"link\").text().trim() ||\r\n                    $(el).find(\"link\").attr(\"href\") || null;\r\n                const pubDate = $(el).find(\"pubDate, published, updated\").text().trim();\r\n                const description = $(el).find(\"description, summary, content\").text().trim() || null;\r\n                const deadline = this.extractDate(pubDate || \"\");\r\n\r\n                results.push({ title, source_url, deadline, description });\r\n            });\r\n        }\r\n\r\n        return results.slice(0, 100); // 최대 100개 제한\r\n    }\r\n\r\n    private async fetchHtml(url: string): Promise<string> {\r\n        const res = await fetch(url, {\r\n            headers: { \"User-Agent\": this.userAgent },\r\n            signal: AbortSignal.timeout(20_000), // 20초 타임아웃\r\n        });\r\n        if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);\r\n        return res.text();\r\n    }\r\n\r\n    /** 텍스트에서 YYYY-MM-DD / YYYY.MM.DD / YYYY/MM/DD 패턴 추출 */\r\n    private extractDate(text: string): string | null {\r\n        const match = text.match(/(\\d{4})[-./](\\d{1,2})[-./](\\d{1,2})/);\r\n        if (!match) return null;\r\n        const [, y, m, d] = match;\r\n        return `${y}-${m.padStart(2, \"0\")}-${d.padStart(2, \"0\")}`;\r\n    }\r\n}\r\n\r\n// ── 동적 스크래퍼 Stub ───────────────────────────────────────────────────────\r\nexport class DynamicScraperStub {\r\n    async scrape(rfpUrl: string, orgName: string): Promise<ScrapedAnnouncement[]> {\r\n        console.warn(\r\n            `[RfpScraper] Dynamic Scraper not available in serverless env. ` +\r\n            `Skipping ${orgName} (${rfpUrl}). ` +\r\n            `To enable: integrate BrowserBase or ScrapingBee API.`\r\n        );\r\n        return [];\r\n    }\r\n}\r\n\r\n// ── 메인 오케스트레이터 ──────────────────────────────────────────────────────\r\nexport class RfpScraper {\r\n    private staticScraper = new StaticScraper();\r\n    private dynamicScraper = new DynamicScraperStub();\r\n\r\n    async run(): Promise<ScrapeOrgResult[]> {\r\n        const supabase = getAdminClient();\r\n        const results: ScrapeOrgResult[] = [];\r\n\r\n        // 1. 수집 활성화된 기관 목록 조회\r\n        const { data: orgs, error: orgsErr } = await supabase\r\n            .from(\"rfp_public_org\")\r\n            .select(\"id, org_name, org_type, homepage_url, rfp_url, coll_meth, is_active\")\r\n            .eq(\"is_active\", true);\r\n\r\n        if (orgsErr) {\r\n            console.error(\"[RfpScraper] Failed to fetch orgs:\", orgsErr.message);\r\n            return [{ org_id: 0, org_name: \"N/A\", status: \"error\", inserted: 0, skipped: 0, error: orgsErr.message }];\r\n        }\r\n\r\n        if (!orgs || orgs.length === 0) {\r\n            console.log(\"[RfpScraper] No active orgs found.\");\r\n            return [];\r\n        }\r\n\r\n        console.log(`[RfpScraper] Processing ${orgs.length} active orgs`);\r\n\r\n        // 2. 기관별 수집\r\n        for (const org of orgs as PublicOrg[]) {\r\n            const result = await this.scrapeOrg(supabase, org);\r\n            results.push(result);\r\n            console.log(\r\n                `[RfpScraper] ${org.org_name}: ${result.status} ` +\r\n                `(inserted=${result.inserted}, skipped=${result.skipped})`\r\n            );\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private async scrapeOrg(supabase: SupabaseClient<any, any, any>, org: PublicOrg): Promise<ScrapeOrgResult> {\r\n        const base: ScrapeOrgResult = {\r\n            org_id: org.id,\r\n            org_name: org.org_name,\r\n            status: \"success\",\r\n            inserted: 0,\r\n            skipped: 0,\r\n        };\r\n\r\n        if (!org.rfp_url) {\r\n            return { ...base, status: \"skipped\", error: \"rfp_url 없음\" };\r\n        }\r\n\r\n        // 3. 엔진 분기\r\n        let announcements: ScrapedAnnouncement[] = [];\r\n        try {\r\n            if (org.coll_meth === \"Dynamic Scraper\") {\r\n                announcements = await this.dynamicScraper.scrape(org.rfp_url, org.org_name);\r\n            } else {\r\n                // Static Scraper, RSS, API 모두 Cheerio 기반 처리\r\n                announcements = await this.staticScraper.scrape(org.rfp_url);\r\n            }\r\n        } catch (err: any) {\r\n            return { ...base, status: \"error\", error: err.message };\r\n        }\r\n\r\n        if (announcements.length === 0) {\r\n            return { ...base, status: \"skipped\", error: \"공고 없음 (파싱 결과 0건)\" };\r\n        }\r\n\r\n        // 4. 증분 저장 (unique_key 기준 upsert → 신규만 INSERT)\r\n        let inserted = 0;\r\n        let skipped = 0;\r\n\r\n        for (const ann of announcements) {\r\n            if (!ann.title?.trim()) continue;\r\n\r\n            const unique_key = buildUniqueKey(org.id, ann.title, ann.deadline);\r\n\r\n            const row = {\r\n                org_id: org.id,\r\n                unique_key,\r\n                title: ann.title.trim(),\r\n                category: ann.category ?? org.org_type ?? null,\r\n                deadline: ann.deadline ?? null,\r\n                description: ann.description ?? null,\r\n                source_url: ann.source_url ?? null,\r\n                is_active: true,\r\n                scraped_at: new Date().toISOString(),\r\n            };\r\n\r\n            // 증분 수집: unique_key 중복 여부 먼저 확인\r\n            const { data: existing } = await supabase\r\n                .from(\"rfp_announcements\")\r\n                .select(\"id\")\r\n                .eq(\"unique_key\", unique_key)\r\n                .maybeSingle();\r\n\r\n            if (existing) {\r\n                skipped++; // 이미 존재 → skip\r\n                continue;\r\n            }\r\n\r\n            const { error: insertErr } = await supabase\r\n                .from(\"rfp_announcements\")\r\n                .insert(row);\r\n\r\n            if (insertErr) {\r\n                console.error(`[RfpScraper] Insert error for \"${ann.title}\":`, insertErr.message);\r\n            } else {\r\n                inserted++;\r\n            }\r\n        }\r\n\r\n        return { ...base, inserted, skipped };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AAAA;AACA;;;AAEA,yEAAyE;AACzE,SAAS;IACL,MAAM;IACN,0DAA0D;IAC1D,MAAM,MACF,QAAQ,GAAG,CAAC,yBAAyB,IACjC,QAAQ,GAAG,CAAC,yBAAyB,KAAK,+BACxC,QAAQ,GAAG,CAAC,yBAAyB;IAE/C,OAAO,IAAA,gMAAY,EAAC,KAAK,KAAK;QAAE,MAAM;YAAE,gBAAgB;QAAM;IAAE;AACpE;AAgCA,6DAA6D;AAC7D,SAAS,eAAe,KAAa,EAAE,KAAa,EAAE,QAAmC;IACrF,MAAM,IAAI,YAAY;IACtB,8CAA8C;IAC9C,OAAO,GAAG,MAAM,EAAE,EAAE,MAAM,IAAI,GAAG,WAAW,GAAG,EAAE,EAAE,GAAG;AAC1D;AAGO,MAAM;IACQ,YACb,kHAAkH;IAEtH,MAAM,OAAO,MAAc,EAAkC;QACzD,MAAM,OAAO,MAAM,IAAI,CAAC,SAAS,CAAC;QAClC,MAAM,IAAI,iKAAY,CAAC;QACvB,MAAM,UAAiC,EAAE;QAEzC,iEAAiE;QACjE,MAAM,YAAY,EAAE,4BAA4B,OAAO;QACvD,IAAI,UAAU,MAAM,GAAG,GAAG;YACtB,KAAK,MAAM,OAAO,UAAW;gBACzB,MAAM,QAAQ,EAAE,KAAK,IAAI,CAAC;gBAC1B,IAAI,MAAM,MAAM,GAAG,GAAG;gBAEtB,MAAM,UAAU,EAAE,KAAK,IAAI,CAAC,QAAQ,KAAK;gBACzC,MAAM,QAAQ,QAAQ,IAAI,GAAG,IAAI,MAAM,EAAE,MAAM,GAAG,CAAC,IAAI,IAAI,GAAG,IAAI;gBAClE,IAAI,CAAC,SAAS,MAAM,MAAM,GAAG,GAAG;gBAEhC,MAAM,OAAO,QAAQ,IAAI,CAAC;gBAC1B,MAAM,aAAa,OACb,KAAK,UAAU,CAAC,UAAU,OAAO,IAAI,IAAI,MAAM,QAAQ,IAAI,GAC3D;gBAEN,gDAAgD;gBAChD,MAAM,UAAU,EAAE,KAAK,IAAI;gBAC3B,MAAM,WAAW,IAAI,CAAC,WAAW,CAAC;gBAElC,QAAQ,IAAI,CAAC;oBAAE;oBAAO;oBAAY;oBAAU,aAAa;gBAAK;YAClE;QACJ;QAEA,mEAAmE;QACnE,IAAI,QAAQ,MAAM,KAAK,GAAG;YACtB,MAAM,YAAY,EACd,gFACF,OAAO;YAET,KAAK,MAAM,MAAM,UAAW;gBACxB,MAAM,QAAQ,EAAE,IAAI,IAAI,GAAG,IAAI;gBAC/B,IAAI,CAAC,SAAS,MAAM,MAAM,GAAG,GAAG;gBAEhC,MAAM,OAAO,EAAE,IAAI,IAAI,CAAC;gBACxB,MAAM,aAAa,OACb,KAAK,UAAU,CAAC,UAAU,OAAO,IAAI,IAAI,MAAM,QAAQ,IAAI,GAC3D;gBAEN,MAAM,aAAa,EAAE,IAAI,MAAM,GAAG,IAAI;gBACtC,MAAM,WAAW,IAAI,CAAC,WAAW,CAAC;gBAElC,QAAQ,IAAI,CAAC;oBAAE;oBAAO;oBAAY;oBAAU,aAAa;gBAAK;YAClE;QACJ;QAEA,sEAAsE;QACtE,IAAI,QAAQ,MAAM,KAAK,KAAK,CAAC,OAAO,QAAQ,CAAC,UAAU,OAAO,QAAQ,CAAC,WAAW,OAAO,QAAQ,CAAC,OAAO,GAAG;YACxG,EAAE,eAAe,IAAI,CAAC,CAAC,GAAG;gBACtB,MAAM,QAAQ,EAAE,IAAI,IAAI,CAAC,SAAS,IAAI,GAAG,IAAI;gBAC7C,IAAI,CAAC,OAAO;gBAEZ,MAAM,aAAa,EAAE,IAAI,IAAI,CAAC,QAAQ,IAAI,GAAG,IAAI,MAC7C,EAAE,IAAI,IAAI,CAAC,QAAQ,IAAI,CAAC,WAAW;gBACvC,MAAM,UAAU,EAAE,IAAI,IAAI,CAAC,+BAA+B,IAAI,GAAG,IAAI;gBACrE,MAAM,cAAc,EAAE,IAAI,IAAI,CAAC,iCAAiC,IAAI,GAAG,IAAI,MAAM;gBACjF,MAAM,WAAW,IAAI,CAAC,WAAW,CAAC,WAAW;gBAE7C,QAAQ,IAAI,CAAC;oBAAE;oBAAO;oBAAY;oBAAU;gBAAY;YAC5D;QACJ;QAEA,OAAO,QAAQ,KAAK,CAAC,GAAG,MAAM,aAAa;IAC/C;IAEA,MAAc,UAAU,GAAW,EAAmB;QAClD,MAAM,MAAM,MAAM,MAAM,KAAK;YACzB,SAAS;gBAAE,cAAc,IAAI,CAAC,SAAS;YAAC;YACxC,QAAQ,YAAY,OAAO,CAAC;QAChC;QACA,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,KAAK,EAAE,IAAI,MAAM,CAAC,KAAK,EAAE,KAAK;QAC5D,OAAO,IAAI,IAAI;IACnB;IAEA,qDAAqD,GACrD,AAAQ,YAAY,IAAY,EAAiB;QAC7C,MAAM,QAAQ,KAAK,KAAK,CAAC;QACzB,IAAI,CAAC,OAAO,OAAO;QACnB,MAAM,GAAG,GAAG,GAAG,EAAE,GAAG;QACpB,OAAO,GAAG,EAAE,CAAC,EAAE,EAAE,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,EAAE,QAAQ,CAAC,GAAG,MAAM;IAC7D;AACJ;AAGO,MAAM;IACT,MAAM,OAAO,MAAc,EAAE,OAAe,EAAkC;QAC1E,QAAQ,IAAI,CACR,CAAC,8DAA8D,CAAC,GAChE,CAAC,SAAS,EAAE,QAAQ,EAAE,EAAE,OAAO,GAAG,CAAC,GACnC,CAAC,oDAAoD,CAAC;QAE1D,OAAO,EAAE;IACb;AACJ;AAGO,MAAM;IACD,gBAAgB,IAAI,gBAAgB;IACpC,iBAAiB,IAAI,qBAAqB;IAElD,MAAM,MAAkC;QACpC,MAAM,WAAW;QACjB,MAAM,UAA6B,EAAE;QAErC,sBAAsB;QACtB,MAAM,EAAE,MAAM,IAAI,EAAE,OAAO,OAAO,EAAE,GAAG,MAAM,SACxC,IAAI,CAAC,kBACL,MAAM,CAAC,uEACP,EAAE,CAAC,aAAa;QAErB,IAAI,SAAS;YACT,QAAQ,KAAK,CAAC,sCAAsC,QAAQ,OAAO;YACnE,OAAO;gBAAC;oBAAE,QAAQ;oBAAG,UAAU;oBAAO,QAAQ;oBAAS,UAAU;oBAAG,SAAS;oBAAG,OAAO,QAAQ,OAAO;gBAAC;aAAE;QAC7G;QAEA,IAAI,CAAC,QAAQ,KAAK,MAAM,KAAK,GAAG;YAC5B,QAAQ,GAAG,CAAC;YACZ,OAAO,EAAE;QACb;QAEA,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,KAAK,MAAM,CAAC,YAAY,CAAC;QAEhE,YAAY;QACZ,KAAK,MAAM,OAAO,KAAqB;YACnC,MAAM,SAAS,MAAM,IAAI,CAAC,SAAS,CAAC,UAAU;YAC9C,QAAQ,IAAI,CAAC;YACb,QAAQ,GAAG,CACP,CAAC,aAAa,EAAE,IAAI,QAAQ,CAAC,EAAE,EAAE,OAAO,MAAM,CAAC,CAAC,CAAC,GACjD,CAAC,UAAU,EAAE,OAAO,QAAQ,CAAC,UAAU,EAAE,OAAO,OAAO,CAAC,CAAC,CAAC;QAElE;QAEA,OAAO;IACX;IAEA,8DAA8D;IAC9D,MAAc,UAAU,QAAuC,EAAE,GAAc,EAA4B;QACvG,MAAM,OAAwB;YAC1B,QAAQ,IAAI,EAAE;YACd,UAAU,IAAI,QAAQ;YACtB,QAAQ;YACR,UAAU;YACV,SAAS;QACb;QAEA,IAAI,CAAC,IAAI,OAAO,EAAE;YACd,OAAO;gBAAE,GAAG,IAAI;gBAAE,QAAQ;gBAAW,OAAO;YAAa;QAC7D;QAEA,WAAW;QACX,IAAI,gBAAuC,EAAE;QAC7C,IAAI;YACA,IAAI,IAAI,SAAS,KAAK,mBAAmB;gBACrC,gBAAgB,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,IAAI,OAAO,EAAE,IAAI,QAAQ;YAC9E,OAAO;gBACH,4CAA4C;gBAC5C,gBAAgB,MAAM,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,OAAO;YAC/D;QACJ,EAAE,OAAO,KAAU;YACf,OAAO;gBAAE,GAAG,IAAI;gBAAE,QAAQ;gBAAS,OAAO,IAAI,OAAO;YAAC;QAC1D;QAEA,IAAI,cAAc,MAAM,KAAK,GAAG;YAC5B,OAAO;gBAAE,GAAG,IAAI;gBAAE,QAAQ;gBAAW,OAAO;YAAmB;QACnE;QAEA,+CAA+C;QAC/C,IAAI,WAAW;QACf,IAAI,UAAU;QAEd,KAAK,MAAM,OAAO,cAAe;YAC7B,IAAI,CAAC,IAAI,KAAK,EAAE,QAAQ;YAExB,MAAM,aAAa,eAAe,IAAI,EAAE,EAAE,IAAI,KAAK,EAAE,IAAI,QAAQ;YAEjE,MAAM,MAAM;gBACR,QAAQ,IAAI,EAAE;gBACd;gBACA,OAAO,IAAI,KAAK,CAAC,IAAI;gBACrB,UAAU,IAAI,QAAQ,IAAI,IAAI,QAAQ,IAAI;gBAC1C,UAAU,IAAI,QAAQ,IAAI;gBAC1B,aAAa,IAAI,WAAW,IAAI;gBAChC,YAAY,IAAI,UAAU,IAAI;gBAC9B,WAAW;gBACX,YAAY,IAAI,OAAO,WAAW;YACtC;YAEA,gCAAgC;YAChC,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC5B,IAAI,CAAC,qBACL,MAAM,CAAC,MACP,EAAE,CAAC,cAAc,YACjB,WAAW;YAEhB,IAAI,UAAU;gBACV,WAAW,eAAe;gBAC1B;YACJ;YAEA,MAAM,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,qBACL,MAAM,CAAC;YAEZ,IAAI,WAAW;gBACX,QAAQ,KAAK,CAAC,CAAC,+BAA+B,EAAE,IAAI,KAAK,CAAC,EAAE,CAAC,EAAE,UAAU,OAAO;YACpF,OAAO;gBACH;YACJ;QACJ;QAEA,OAAO;YAAE,GAAG,IAAI;YAAE;YAAU;QAAQ;IACxC;AACJ"}},
    {"offset": {"line": 428, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/app/api/cron/rfp-scrape/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { RfpScraper } from \"@/lib/services/rfp-scraper\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\nexport const maxDuration = 300; // Vercel Pro: 최대 5분 실행 허용\r\n\r\nexport async function GET(request: Request) {\r\n    // ── 보안: CRON_SECRET 검증 ─────────────────────────────────────────────\r\n    const authHeader = request.headers.get(\"authorization\");\r\n    const cronSecret = process.env.CRON_SECRET;\r\n\r\n    if (cronSecret && authHeader !== `Bearer ${cronSecret}`) {\r\n        console.warn(\"[rfp-scrape] Unauthorized cron request\");\r\n        return new NextResponse(\"Unauthorized\", { status: 401 });\r\n    }\r\n\r\n    const startedAt = new Date().toISOString();\r\n    console.log(`[rfp-scrape] Cron started at ${startedAt}`);\r\n\r\n    try {\r\n        const scraper = new RfpScraper();\r\n        const results = await scraper.run();\r\n\r\n        const totalInserted = results.reduce((s, r) => s + r.inserted, 0);\r\n        const totalSkipped = results.reduce((s, r) => s + r.skipped, 0);\r\n        const errors = results.filter((r) => r.status === \"error\");\r\n\r\n        console.log(\r\n            `[rfp-scrape] Done. inserted=${totalInserted}, skipped=${totalSkipped}, errors=${errors.length}`\r\n        );\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            startedAt,\r\n            completedAt: new Date().toISOString(),\r\n            summary: {\r\n                totalOrgs: results.length,\r\n                totalInserted,\r\n                totalSkipped,\r\n                totalErrors: errors.length,\r\n            },\r\n            results,\r\n        });\r\n    } catch (err: any) {\r\n        console.error(\"[rfp-scrape] Fatal error:\", err);\r\n        return NextResponse.json(\r\n            { success: false, error: err.message, startedAt },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAChB,MAAM,cAAc,KAAK,0BAA0B;AAEnD,eAAe,IAAI,OAAgB;IACtC,sEAAsE;IACtE,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,MAAM,aAAa,QAAQ,GAAG,CAAC,WAAW;IAE1C,IAAI,cAAc,eAAe,CAAC,OAAO,EAAE,YAAY,EAAE;QACrD,QAAQ,IAAI,CAAC;QACb,OAAO,IAAI,gJAAY,CAAC,gBAAgB;YAAE,QAAQ;QAAI;IAC1D;IAEA,MAAM,YAAY,IAAI,OAAO,WAAW;IACxC,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,WAAW;IAEvD,IAAI;QACA,MAAM,UAAU,IAAI,wJAAU;QAC9B,MAAM,UAAU,MAAM,QAAQ,GAAG;QAEjC,MAAM,gBAAgB,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,EAAE,QAAQ,EAAE;QAC/D,MAAM,eAAe,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,EAAE,OAAO,EAAE;QAC7D,MAAM,SAAS,QAAQ,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;QAElD,QAAQ,GAAG,CACP,CAAC,4BAA4B,EAAE,cAAc,UAAU,EAAE,aAAa,SAAS,EAAE,OAAO,MAAM,EAAE;QAGpG,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT;YACA,aAAa,IAAI,OAAO,WAAW;YACnC,SAAS;gBACL,WAAW,QAAQ,MAAM;gBACzB;gBACA;gBACA,aAAa,OAAO,MAAM;YAC9B;YACA;QACJ;IACJ,EAAE,OAAO,KAAU;QACf,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,SAAS;YAAO,OAAO,IAAI,OAAO;YAAE;QAAU,GAChD;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}