{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/nia-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\n\r\nconst BASE_URL = \"https://www.nia.or.kr\";\r\nconst LIST_URL = `${BASE_URL}/site/nia_kor/ex/bbs/List.do?cbIdx=78336`;\r\nconst DETAIL_URL = `${BASE_URL}/site/nia_kor/ex/bbs/View.do`;\r\n\r\nconst USER_AGENT =\r\n    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\nexport type NiaAnnouncement = {\r\n    bcIdx: string;\r\n    title: string;\r\n    date: string;          // YYYY-MM-DD\r\n    content: string;\r\n    source_url: string;\r\n};\r\n\r\n// ── HTML fetch helper ─────────────────────────────────────────────────────────\r\nasync function fetchHtml(url: string): Promise<string> {\r\n    const res = await fetch(url, {\r\n        headers: {\r\n            \"User-Agent\": USER_AGENT,\r\n            \"Referer\": BASE_URL,\r\n        },\r\n        signal: AbortSignal.timeout(20_000),\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);\r\n    return res.text();\r\n}\r\n\r\n// ── 날짜 정규화 (2026.02.24 → 2026-02-24) ────────────────────────────────────\r\nfunction normalizeDate(raw: string): string {\r\n    const m = raw.trim().match(/(\\d{4})[.\\-/](\\d{1,2})[.\\-/](\\d{1,2})/);\r\n    if (!m) return raw.trim();\r\n    return `${m[1]}-${m[2].padStart(2, \"0\")}-${m[3].padStart(2, \"0\")}`;\r\n}\r\n\r\n// ── 목록 페이지에서 bcIdx 목록 추출 ──────────────────────────────────────────\r\nexport async function fetchNiaList(maxPages: number = 1): Promise<Array<{ bcIdx: string; title: string; date: string }>> {\r\n    const items: Array<{ bcIdx: string; title: string; date: string }> = [];\r\n\r\n    for (let page = 1; page <= maxPages; page++) {\r\n        const url = page === 1 ? LIST_URL : `${LIST_URL}&pageIndex=${page}`;\r\n        const html = await fetchHtml(url);\r\n        const $ = cheerio.load(html);\r\n\r\n        // a[href=\"#view\"] 기반으로 공고 항목 탐색 (ul.board-list 클래스 없음)\r\n        $(\"a[href='#view']\").each((_, anchor) => {\r\n            const onclick = $(anchor).attr(\"onclick\") ?? \"\";\r\n            // onclick: doBbsFView('78336','29066','16010100','29066');return false;\r\n            const match = onclick.match(/doBbsFView\\(\\s*['\"]?\\d+['\"]?\\s*,\\s*['\"]?(\\d+)['\"]?/);\r\n            if (!match) return;\r\n            const bcIdx = match[1];\r\n\r\n            // 제목: 첫 번째 span (new/첨부 아이콘 제외)\r\n            const spans = $(anchor).find(\"span\").toArray();\r\n            const title = spans\r\n                .map((s) => $(s).clone().children().remove().end().text().trim())\r\n                .filter((t) => t.length > 3 && !/첨부|new|N/i.test(t))\r\n                .join(\" \")\r\n                .trim() || $(anchor).text().replace(/\\s+/g, \" \").trim().split(\" \")[0];\r\n\r\n            if (!title || title.length < 2) return;\r\n\r\n            // 날짜: 같은 a 태그 내 em 또는 span > em에서 날짜 패턴\r\n            const dateRaw = $(anchor).find(\"em\").toArray()\r\n                .map((e) => $(e).text().trim())\r\n                .find((t) => /\\d{4}[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/.test(t)) ?? \"\";\r\n            const date = normalizeDate(dateRaw);\r\n\r\n            items.push({ bcIdx, title, date });\r\n        });\r\n\r\n        if (items.length === 0 && page === 1) break;\r\n    }\r\n\r\n    return items;\r\n}\r\n\r\n// ── 상세 페이지에서 내용 추출 ─────────────────────────────────────────────────\r\nexport async function fetchNiaDetail(bcIdx: string): Promise<{ content: string; date: string }> {\r\n    const url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${bcIdx}`;\r\n    const html = await fetchHtml(url);\r\n    const $ = cheerio.load(html);\r\n\r\n    // 날짜: .src em 또는 .type01_info em\r\n    const dateRaw =\r\n        $(\".detail_type01 .src em, .type01_info .src em, .src em\").first().text().trim() ||\r\n        $(\".date, .reg_date\").first().text().trim();\r\n    const date = normalizeDate(dateRaw);\r\n\r\n    // 본문: .con_area 내부 텍스트 (HTML태그 제거, 정제)\r\n    const conArea = $(\".detail_type01 .con_area, .con_area\").first();\r\n    const content = conArea.text()\r\n        .replace(/\\s{3,}/g, \"\\n\\n\")  // 연속 공백/줄바꿈 정리\r\n        .trim();\r\n\r\n    return { content, date };\r\n}\r\n\r\n// ── 전체 수집 파이프라인 ──────────────────────────────────────────────────────\r\nexport async function scrapeNiaAnnouncements(\r\n    maxPages: number = 1,\r\n    fetchDetail: boolean = true\r\n): Promise<NiaAnnouncement[]> {\r\n    const listItems = await fetchNiaList(maxPages);\r\n    const results: NiaAnnouncement[] = [];\r\n\r\n    for (const item of listItems) {\r\n        const source_url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${item.bcIdx}`;\r\n\r\n        let content = \"\";\r\n        let date = item.date;\r\n\r\n        if (fetchDetail) {\r\n            try {\r\n                const detail = await fetchNiaDetail(item.bcIdx);\r\n                content = detail.content;\r\n                // 상세 페이지 날짜가 더 정확한 경우 사용\r\n                if (detail.date) date = detail.date;\r\n            } catch (e) {\r\n                console.warn(`[NiaScraper] Detail fetch failed for bcIdx=${item.bcIdx}:`, e);\r\n            }\r\n        }\r\n\r\n        results.push({\r\n            bcIdx: item.bcIdx,\r\n            title: item.title,\r\n            date,\r\n            content,\r\n            source_url,\r\n        });\r\n    }\r\n\r\n    return results;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 306, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/app/api/cron/nia-scrape/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { createClient } from \"@supabase/supabase-js\";\r\nimport { scrapeNiaAnnouncements } from \"@/lib/services/nia-scraper\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\nexport const maxDuration = 300;\r\n\r\nconst ORG_RFP_URL = \"https://www.nia.or.kr/site/nia_kor/ex/bbs/List.do?cbIdx=78336\";\r\n\r\n// anon key fallback (RLS disabled on rfp_announcements)\r\nfunction getSupabase() {\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n    const key =\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY &&\r\n            process.env.SUPABASE_SERVICE_ROLE_KEY !== \"your-service-role-key-here\"\r\n            ? process.env.SUPABASE_SERVICE_ROLE_KEY\r\n            : process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n    return createClient(url, key, { auth: { persistSession: false } });\r\n}\r\n\r\nexport async function GET(request: Request) {\r\n    // 보안 검증\r\n    const authHeader = request.headers.get(\"authorization\");\r\n    const cronSecret = process.env.CRON_SECRET;\r\n    if (cronSecret && authHeader !== `Bearer ${cronSecret}`) {\r\n        return new NextResponse(\"Unauthorized\", { status: 401 });\r\n    }\r\n\r\n    const startedAt = new Date().toISOString();\r\n    const supabase = getSupabase();\r\n\r\n    try {\r\n        // 1. rfp_public_org에서 NIA 기관 ID 조회 (rfp_url로 매핑)\r\n        const { data: org } = await supabase\r\n            .from(\"rfp_public_org\")\r\n            .select(\"id, org_name\")\r\n            .eq(\"rfp_url\", ORG_RFP_URL)\r\n            .maybeSingle();\r\n\r\n        const orgId: number = org?.id ?? 0; // 미등록이면 0 (테스트용)\r\n        const orgName: string = org?.org_name ?? \"한국지능정보사회진흥원(NIA)\";\r\n\r\n        console.log(`[nia-scrape] Start scraping for ${orgName} (org_id=${orgId})`);\r\n\r\n        // 2. NIA 공고 수집 (최신 1페이지 = 10건)\r\n        const announcements = await scrapeNiaAnnouncements(1, true);\r\n        console.log(`[nia-scrape] Fetched ${announcements.length} announcements`);\r\n\r\n        let inserted = 0;\r\n        let skipped = 0;\r\n        const errors: string[] = [];\r\n\r\n        // 3. DB 증분 저장\r\n        for (const ann of announcements) {\r\n            const unique_key = `${orgId}::nia::${ann.bcIdx}`;\r\n\r\n            // 중복 체크\r\n            const { data: existing } = await supabase\r\n                .from(\"rfp_announcements\")\r\n                .select(\"id\")\r\n                .eq(\"unique_key\", unique_key)\r\n                .maybeSingle();\r\n\r\n            if (existing) {\r\n                skipped++;\r\n                continue;\r\n            }\r\n\r\n            const { error } = await supabase.from(\"rfp_announcements\").insert({\r\n                org_id: orgId || null,\r\n                unique_key,\r\n                title: ann.title,\r\n                category: \"입찰공고\",\r\n                deadline: ann.date || null,\r\n                description: ann.content?.slice(0, 2000) || null, // 최대 2000자\r\n                source_url: ann.source_url,\r\n                is_active: true,\r\n                scraped_at: new Date().toISOString(),\r\n            });\r\n\r\n            if (error) {\r\n                console.error(`[nia-scrape] Insert error:`, error.message);\r\n                errors.push(`${ann.title}: ${error.message}`);\r\n            } else {\r\n                inserted++;\r\n            }\r\n        }\r\n\r\n        console.log(`[nia-scrape] Done. inserted=${inserted}, skipped=${skipped}, errors=${errors.length}`);\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            startedAt,\r\n            completedAt: new Date().toISOString(),\r\n            org: orgName,\r\n            summary: {\r\n                fetched: announcements.length,\r\n                inserted,\r\n                skipped,\r\n                errors: errors.length,\r\n            },\r\n            errorDetails: errors,\r\n        });\r\n    } catch (err: any) {\r\n        console.error(\"[nia-scrape] Fatal:\", err);\r\n        return NextResponse.json(\r\n            { success: false, error: err.message, startedAt },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}