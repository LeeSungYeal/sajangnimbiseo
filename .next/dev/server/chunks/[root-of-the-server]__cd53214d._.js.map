{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/nia-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\n\r\nconst BASE_URL = \"https://www.nia.or.kr\";\r\nconst LIST_URL = `${BASE_URL}/site/nia_kor/ex/bbs/List.do?cbIdx=78336`;\r\nconst DETAIL_URL = `${BASE_URL}/site/nia_kor/ex/bbs/View.do`;\r\n\r\nconst USER_AGENT =\r\n    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\nexport type NiaAnnouncement = {\r\n    bcIdx: string;\r\n    title: string;\r\n    date: string;          // YYYY-MM-DD\r\n    content: string;\r\n    source_url: string;\r\n};\r\n\r\n// ── HTML fetch helper ─────────────────────────────────────────────────────────\r\nasync function fetchHtml(url: string): Promise<string> {\r\n    const res = await fetch(url, {\r\n        headers: {\r\n            \"User-Agent\": USER_AGENT,\r\n            \"Referer\": BASE_URL,\r\n        },\r\n        signal: AbortSignal.timeout(20_000),\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);\r\n    return res.text();\r\n}\r\n\r\n// ── 날짜 정규화 (2026.02.24 → 2026-02-24) ────────────────────────────────────\r\nfunction normalizeDate(raw: string): string {\r\n    const m = raw.trim().match(/(\\d{4})[.\\-/](\\d{1,2})[.\\-/](\\d{1,2})/);\r\n    if (!m) return raw.trim();\r\n    return `${m[1]}-${m[2].padStart(2, \"0\")}-${m[3].padStart(2, \"0\")}`;\r\n}\r\n\r\n// ── 목록 페이지에서 bcIdx 목록 추출 ──────────────────────────────────────────\r\nexport async function fetchNiaList(maxPages: number = 1): Promise<Array<{ bcIdx: string; title: string; date: string }>> {\r\n    const items: Array<{ bcIdx: string; title: string; date: string }> = [];\r\n\r\n    for (let page = 1; page <= maxPages; page++) {\r\n        const url = page === 1 ? LIST_URL : `${LIST_URL}&pageIndex=${page}`;\r\n        const html = await fetchHtml(url);\r\n        const $ = cheerio.load(html);\r\n\r\n        // a[href=\"#view\"] 기반으로 공고 항목 탐색 (ul.board-list 클래스 없음)\r\n        $(\"a[href='#view']\").each((_, anchor) => {\r\n            const onclick = $(anchor).attr(\"onclick\") ?? \"\";\r\n            // onclick: doBbsFView('78336','29066','16010100','29066');return false;\r\n            const match = onclick.match(/doBbsFView\\(\\s*['\"]?\\d+['\"]?\\s*,\\s*['\"]?(\\d+)['\"]?/);\r\n            if (!match) return;\r\n            const bcIdx = match[1];\r\n\r\n            // 제목: span 목록에서 아이콘/뱃지 제외하고 텍스트 합치기\r\n            const spans = $(anchor).find(\"span\").toArray();\r\n            const spanTexts = spans\r\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                .map((s: any) => $(s).clone().children().remove().end().text().trim())\r\n                .filter((t: string) => t.length > 1 && !/^(첨부|new|N)$/i.test(t));\r\n\r\n            // span에서 추출 실패하면 anchor 전체 텍스트(정제) 사용\r\n            const title = spanTexts.length > 0\r\n                ? spanTexts.join(\" \").replace(/\\s+/g, \" \").trim()\r\n                : $(anchor).clone().find(\"em\").remove().end().text().replace(/\\s+/g, \" \").trim();\r\n\r\n            if (!title || title.length < 2) return;\r\n\r\n            // 날짜: 같은 a 태그 내 em 또는 span > em에서 날짜 패턴\r\n            const dateRaw = $(anchor).find(\"em\").toArray()\r\n                .map((e) => $(e).text().trim())\r\n                .find((t) => /\\d{4}[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/.test(t)) ?? \"\";\r\n            const date = normalizeDate(dateRaw);\r\n\r\n            items.push({ bcIdx, title, date });\r\n        });\r\n\r\n        if (items.length === 0 && page === 1) break;\r\n    }\r\n\r\n    return items;\r\n}\r\n\r\n// ── 상세 페이지에서 내용 추출 ─────────────────────────────────────────────────\r\nexport async function fetchNiaDetail(bcIdx: string): Promise<{ content: string; date: string }> {\r\n    const url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${bcIdx}`;\r\n    const html = await fetchHtml(url);\r\n    const $ = cheerio.load(html);\r\n\r\n    // 날짜: .src em 또는 .type01_info em\r\n    const dateRaw =\r\n        $(\".detail_type01 .src em, .type01_info .src em, .src em\").first().text().trim() ||\r\n        $(\".date, .reg_date\").first().text().trim();\r\n    const date = normalizeDate(dateRaw);\r\n\r\n    // 본문: .con_area 내부 텍스트 (HTML태그 제거, 정제)\r\n    const conArea = $(\".detail_type01 .con_area, .con_area\").first();\r\n    const content = conArea.text()\r\n        .replace(/\\s{3,}/g, \"\\n\\n\")  // 연속 공백/줄바꿈 정리\r\n        .trim();\r\n\r\n    return { content, date };\r\n}\r\n\r\n// ── 전체 수집 파이프라인 ──────────────────────────────────────────────────────\r\nexport async function scrapeNiaAnnouncements(\r\n    maxPages: number = 1,\r\n    fetchDetail: boolean = true\r\n): Promise<NiaAnnouncement[]> {\r\n    const listItems = await fetchNiaList(maxPages);\r\n    const results: NiaAnnouncement[] = [];\r\n\r\n    for (const item of listItems) {\r\n        const source_url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${item.bcIdx}`;\r\n\r\n        let content = \"\";\r\n        let date = item.date;\r\n\r\n        if (fetchDetail) {\r\n            try {\r\n                const detail = await fetchNiaDetail(item.bcIdx);\r\n                content = detail.content;\r\n                // 상세 페이지 날짜가 더 정확한 경우 사용\r\n                if (detail.date) date = detail.date;\r\n            } catch (e) {\r\n                console.warn(`[NiaScraper] Detail fetch failed for bcIdx=${item.bcIdx}:`, e);\r\n            }\r\n        }\r\n\r\n        results.push({\r\n            bcIdx: item.bcIdx,\r\n            title: item.title,\r\n            date,\r\n            content,\r\n            source_url,\r\n        });\r\n    }\r\n\r\n    return results;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 309, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/nipa-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\n\r\nconst BASE_URL = \"https://www.nipa.kr\";\r\nconst LIST_URL = `${BASE_URL}/home/2-3/`;\r\n\r\nconst USER_AGENT =\r\n    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\nexport type NipaAnnouncement = {\r\n    articleId: string;\r\n    title: string;\r\n    date: string;       // YYYY-MM-DD\r\n    content: string;\r\n    source_url: string;\r\n};\r\n\r\n// ── fetch helper ──────────────────────────────────────────────────────────────\r\nasync function fetchHtml(url: string): Promise<string> {\r\n    const res = await fetch(url, {\r\n        headers: {\r\n            \"User-Agent\": USER_AGENT,\r\n            \"Referer\": BASE_URL,\r\n        },\r\n        signal: AbortSignal.timeout(20_000),\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);\r\n    return res.text();\r\n}\r\n\r\n// ── 날짜 정규화 ───────────────────────────────────────────────────────────────\r\nfunction normalizeDate(raw: string): string {\r\n    const m = raw.trim().match(/(\\d{4})[.\\-/](\\d{1,2})[.\\-/](\\d{1,2})/);\r\n    if (!m) return raw.trim();\r\n    return `${m[1]}-${m[2].padStart(2, \"0\")}-${m[3].padStart(2, \"0\")}`;\r\n}\r\n\r\n// ── 목록 페이지에서 articleId 추출 ───────────────────────────────────────────\r\nexport async function fetchNipaList(\r\n    maxPages: number = 1\r\n): Promise<Array<{ articleId: string; title: string; date: string }>> {\r\n    const items: Array<{ articleId: string; title: string; date: string }> = [];\r\n\r\n    for (let page = 1; page <= maxPages; page++) {\r\n        const url = page === 1 ? LIST_URL : `${LIST_URL}?page=${page}`;\r\n        const html = await fetchHtml(url);\r\n        const $ = cheerio.load(html);\r\n\r\n        // 선택자: table.tb03 tbody tr > td.al > a (제목 링크)\r\n        // 대안: td a[href*=\"/home/2-3/\"]\r\n        const linkEls = $(\"table td a[href*='/home/2-3/'], table.tb03 td.al a\").toArray();\r\n\r\n        if (linkEls.length === 0) {\r\n            // 폴백: 모든 a[href] 에서 /home/2-3/{숫자} 패턴 탐색\r\n            $(\"a[href]\").each((_, el) => {\r\n                const href = $(el).attr(\"href\") ?? \"\";\r\n                const match = href.match(/\\/home\\/2-3\\/(\\d+)/);\r\n                if (!match) return;\r\n                const articleId = match[1];\r\n                const title = $(el).text().trim();\r\n                if (!title || title.length < 2) return;\r\n\r\n                const rowText = $(el).closest(\"tr\").text();\r\n                const date = normalizeDate(\r\n                    rowText.match(/(\\d{4})[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/)?.[0] ?? \"\"\r\n                );\r\n                if (!items.find((i) => i.articleId === articleId)) {\r\n                    items.push({ articleId, title, date });\r\n                }\r\n            });\r\n        } else {\r\n            for (const el of linkEls) {\r\n                const href = $(el).attr(\"href\") ?? \"\";\r\n                const match = href.match(/\\/home\\/2-3\\/(\\d+)/);\r\n                if (!match) continue;\r\n                const articleId = match[1];\r\n\r\n                const title = $(el).text().replace(/\\s+/g, \" \").trim();\r\n                if (!title || title.length < 2) continue;\r\n\r\n                // 날짜: 같은 tr의 텍스트에서 추출\r\n                const rowText = $(el).closest(\"tr\").text();\r\n                const date = normalizeDate(\r\n                    rowText.match(/(\\d{4})[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/)?.[0] ?? \"\"\r\n                );\r\n                if (!items.find((i) => i.articleId === articleId)) {\r\n                    items.push({ articleId, title, date });\r\n                }\r\n            }\r\n        }\r\n\r\n        if (linkEls.length === 0) break;\r\n    }\r\n\r\n    return items;\r\n}\r\n\r\n// ── 상세 페이지에서 내용 추출 ─────────────────────────────────────────────────\r\nexport async function fetchNipaDetail(\r\n    articleId: string\r\n): Promise<{ content: string; date: string; title: string }> {\r\n    const url = `${BASE_URL}/home/2-3/${articleId}`;\r\n    const html = await fetchHtml(url);\r\n    const $ = cheerio.load(html);\r\n\r\n    // 제목: table.tb05 thead tr th, .view-title, h3 등\r\n    const title =\r\n        $(\"table.tb05 thead tr th, .view-title, .tit_view, h3.tit\").first().text().trim() ||\r\n        $(\"h2, h3\").first().text().trim();\r\n\r\n    // 날짜: span.infoDt, .reg-date, .date 등\r\n    const dateRaw =\r\n        $(\"span.infoDt, .reg-date, [class*='date']\").toArray()\r\n            .map((e) => $(e).text().trim())\r\n            .find((t) => /\\d{4}[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/.test(t)) ?? \"\";\r\n    const date = normalizeDate(dateRaw);\r\n\r\n    // 본문: div.tbCont, .view-content, .board-content\r\n    const content =\r\n        $(\"div.tbCont, .view-content, .board-content, .con_area\").first()\r\n            .text()\r\n            .replace(/\\s{3,}/g, \"\\n\\n\")\r\n            .trim();\r\n\r\n    return { title, date, content };\r\n}\r\n\r\n// ── 전체 수집 파이프라인 ──────────────────────────────────────────────────────\r\nexport async function scrapeNipaAnnouncements(\r\n    maxPages: number = 1,\r\n    fetchDetail: boolean = true\r\n): Promise<NipaAnnouncement[]> {\r\n    const listItems = await fetchNipaList(maxPages);\r\n    const results: NipaAnnouncement[] = [];\r\n\r\n    for (const item of listItems) {\r\n        const source_url = `${BASE_URL}/home/2-3/${item.articleId}`;\r\n        let content = \"\";\r\n        let date = item.date;\r\n        let title = item.title;\r\n\r\n        if (fetchDetail) {\r\n            try {\r\n                const detail = await fetchNipaDetail(item.articleId);\r\n                content = detail.content;\r\n                if (detail.date) date = detail.date;\r\n                if (detail.title && detail.title.length > title.length) title = detail.title;\r\n            } catch (e) {\r\n                console.warn(`[NipaScraper] Detail fetch failed for articleId=${item.articleId}:`, e);\r\n            }\r\n        }\r\n\r\n        results.push({ articleId: item.articleId, title, date, content, source_url });\r\n    }\r\n\r\n    return results;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 442, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/iitp-scraper.ts"],"sourcesContent":["/**\r\n * IITP (정보통신기획평가원) 입찰공고 스크래퍼\r\n *\r\n * 목록 API: POST https://www.iitp.kr/board-svc/api/bbs/A/list.do\r\n * 상세 API: POST https://www.iitp.kr/board-svc/api/bbs/A/view.do (내용 추출용)\r\n *\r\n * 목록 응답 필드: rn, article_seq, board_seq, title, reg_dt, reg_nm, ...\r\n * 상세 응답 필드: article_seq, title, content(nttCn), reg_dt, ...\r\n */\r\n\r\nconst BASE_URL = \"https://www.iitp.kr\";\r\nconst LIST_API_URL = `${BASE_URL}/board-svc/api/bbs/A/list.do`;\r\nconst VIEW_API_URL = `${BASE_URL}/board-svc/api/bbs/A/view.do`;\r\nconst LIST_PAGE_URL = `${BASE_URL}/web/lay1/bbs/S1T12C38/A/8/list.do`;\r\nconst DETAIL_PAGE_URL = `${BASE_URL}/web/lay1/bbs/S1T12C38/A/8/view.do`;\r\n\r\nconst CMS_MENU_SEQ = \"38\";\r\n\r\nconst USER_AGENT =\r\n    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\nconst COMMON_HEADERS = {\r\n    \"User-Agent\": USER_AGENT,\r\n    \"Content-Type\": \"application/json\",\r\n    \"Accept\": \"application/json, text/plain, */*\",\r\n    \"Referer\": LIST_PAGE_URL,\r\n    \"Origin\": BASE_URL,\r\n};\r\n\r\nexport type IitpAnnouncement = {\r\n    articleId: string;\r\n    title: string;\r\n    date: string;       // YYYY-MM-DD\r\n    content: string;\r\n    source_url: string;\r\n};\r\n\r\n// ── 목록 API 호출 ─────────────────────────────────────────────────────────────\r\nasync function fetchIitpList(rows: number = 20): Promise<Array<{\r\n    articleId: string;\r\n    title: string;\r\n    date: string;\r\n    source_url: string;\r\n}>> {\r\n    const res = await fetch(LIST_API_URL, {\r\n        method: \"POST\",\r\n        headers: COMMON_HEADERS,\r\n        body: JSON.stringify({\r\n            cms_menu_seq: CMS_MENU_SEQ,\r\n            cpage: 1,\r\n            rows: String(rows),\r\n            keyword: \"\",\r\n            condition: \"\",\r\n            sort: \"latest\",\r\n        }),\r\n        signal: AbortSignal.timeout(20_000),\r\n    });\r\n\r\n    if (!res.ok) throw new Error(`[IitpScraper] List API HTTP ${res.status}`);\r\n\r\n    const json = await res.json();\r\n    if (json.result !== \"SUCCESS\") throw new Error(`[IitpScraper] List API result=${json.result}`);\r\n\r\n    const items: any[] = json.list ?? [];\r\n    console.log(`[IitpScraper] 목록 API: ${items.length}건`);\r\n\r\n    return items\r\n        .filter((item: any) => item.title?.trim().length > 1)\r\n        .map((item: any) => ({\r\n            articleId: String(item.article_seq),\r\n            title: String(item.title).trim(),\r\n            date: String(item.reg_dt ?? \"\"),          // 이미 YYYY-MM-DD 형식\r\n            source_url: `${DETAIL_PAGE_URL}?article_seq=${item.article_seq}&cms_menu_seq=${CMS_MENU_SEQ}`,\r\n        }));\r\n}\r\n\r\n// ── 상세 API 호출 (내용 추출) ─────────────────────────────────────────────────\r\n// 응답 구조: { result: \"SUCCESS\", data: { view: { conts, reg_dt, ... }, next: {...} } }\r\nasync function fetchIitpDetail(articleSeq: string): Promise<string> {\r\n    try {\r\n        const res = await fetch(VIEW_API_URL, {\r\n            method: \"POST\",\r\n            headers: COMMON_HEADERS,\r\n            body: JSON.stringify({\r\n                cms_menu_seq: CMS_MENU_SEQ,\r\n                article_seq: articleSeq,\r\n                sort: \"latest\",\r\n                cpage: 1,\r\n                rows: \"20\",\r\n                keyword: \"\",\r\n                condition: \"\",\r\n            }),\r\n            signal: AbortSignal.timeout(15_000),\r\n        });\r\n\r\n        if (!res.ok) return \"\";\r\n\r\n        const json = await res.json();\r\n        if (json.result !== \"SUCCESS\") return \"\";\r\n\r\n        // 응답: data.view.conts (HTML)\r\n        const viewItem = json.data?.view ?? json.view ?? json.data ?? json;\r\n        const rawContent = String(\r\n            viewItem.conts ?? viewItem.nttCn ?? viewItem.content ?? viewItem.cn ?? \"\"\r\n        ).trim();\r\n\r\n        // HTML 태그 제거 후 공백 정리\r\n        return rawContent.replace(/<[^>]+>/g, \" \").replace(/&[a-z]+;/gi, \" \").replace(/\\s{2,}/g, \" \").trim();\r\n    } catch {\r\n        return \"\";\r\n    }\r\n}\r\n\r\n// ── 전체 수집 파이프라인 ──────────────────────────────────────────────────────\r\nexport async function scrapeIitpAnnouncements(\r\n    maxRows: number = 20,\r\n    fetchDetail: boolean = true,\r\n): Promise<IitpAnnouncement[]> {\r\n    console.log(\"[IitpScraper] 수집 시작\");\r\n\r\n    let listItems: Awaited<ReturnType<typeof fetchIitpList>>;\r\n    try {\r\n        listItems = await fetchIitpList(maxRows);\r\n    } catch (err: any) {\r\n        console.error(\"[IitpScraper] 목록 수집 실패:\", err.message);\r\n        return [];\r\n    }\r\n\r\n    const results: IitpAnnouncement[] = [];\r\n\r\n    for (const item of listItems) {\r\n        let content = \"\";\r\n\r\n        if (fetchDetail) {\r\n            content = await fetchIitpDetail(item.articleId);\r\n            if (!content) {\r\n                console.warn(`[IitpScraper] 상세 내용 없음 article_seq=${item.articleId}`);\r\n            }\r\n        }\r\n\r\n        results.push({\r\n            articleId: item.articleId,\r\n            title: item.title,\r\n            date: item.date,\r\n            content,\r\n            source_url: item.source_url,\r\n        });\r\n    }\r\n\r\n    console.log(`[IitpScraper] 최종 수집: ${results.length}건`);\r\n    return results;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 558, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/keit-scraper.ts"],"sourcesContent":["/**\r\n * KEIT (한국산업기술기획평가원) 과제공고 스크래퍼\r\n *\r\n * 사이트: https://srome.keit.re.kr/srome/biz/perform/opnnPrpsl/retrieveTaskAnncmListView.do\r\n * 방식: SSR HTML → Cheerio 파싱\r\n *\r\n * HTML 구조 (확인된 패턴):\r\n *   - 제목: 각 공고 항목의 a 태그\r\n *   - 등록일: \"등록일YYYY-MM-DD\" 텍스트 패턴\r\n *   - 접수기간: \"접수기간YYYY-MM-DD HH:MM ~ YYYY-MM-DD HH:MM\" 패턴\r\n *   - 상세 링크: onclick 또는 별도 파라미터로 이동 → 없으면 목록 URL 사용\r\n */\r\n\r\nimport * as cheerio from \"cheerio\";\r\n\r\nconst BASE_URL = \"https://srome.keit.re.kr\";\r\nconst LIST_URL = `${BASE_URL}/srome/biz/perform/opnnPrpsl/retrieveTaskAnncmListView.do`;\r\n\r\nconst USER_AGENT =\r\n    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\nexport type KeitAnnouncement = {\r\n    articleId: string;\r\n    title: string;\r\n    date: string;           // 등록일 YYYY-MM-DD\r\n    receiptStart: string;   // 접수 시작일\r\n    receiptEnd: string;     // 접수 마감일\r\n    source_url: string;\r\n};\r\n\r\n// ── fetch helper ──────────────────────────────────────────────────────────────\r\nasync function fetchHtml(url: string): Promise<string> {\r\n    const res = await fetch(url, {\r\n        headers: {\r\n            \"User-Agent\": USER_AGENT,\r\n            \"Referer\": BASE_URL,\r\n            \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\r\n            \"Accept-Language\": \"ko-KR,ko;q=0.9\",\r\n        },\r\n        signal: AbortSignal.timeout(20_000),\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);\r\n    return res.text();\r\n}\r\n\r\n// ── 날짜 추출 helper ──────────────────────────────────────────────────────────\r\nfunction extractDate(text: string): string {\r\n    const m = text.match(/(\\d{4})-(\\d{2})-(\\d{2})/);\r\n    if (!m) return \"\";\r\n    return `${m[1]}-${m[2]}-${m[3]}`;\r\n}\r\n\r\n// ── 목록 파싱 ─────────────────────────────────────────────────────────────────\r\n// 실제 HTML 구조 (디버그로 확인):\r\n//   <div class=\"table_box_wrap\">\r\n//     <p class=\"no\">676</p>\r\n//     <div class=\"table_box_detail\">\r\n//       <p class=\"subject\">\r\n//         <a onclick=\"f_detail('I18835', '2026'); return false;\" href=\"#\">\r\n//           <span class=\"title\">2026년도 자동차산업기술개발사업...</span>\r\n//         </a>\r\n//       </p>\r\n//       <div class=\"info\">\r\n//         <p><span class=\"label\">접수기간</span><span class=\"value\">2026-02-06 09:00 ~ 2026-04-08 18:00</span></p>\r\n//         <p><span class=\"label\">등록일</span><span class=\"value\">2026-02-10</span></p>\r\n//       </div>\r\n//     </div>\r\n//   </div>\r\nasync function fetchKeitList(maxPages: number = 1): Promise<KeitAnnouncement[]> {\r\n    const results: KeitAnnouncement[] = [];\r\n    const seen = new Set<string>();\r\n\r\n    for (let page = 1; page <= maxPages; page++) {\r\n        const url = page === 1\r\n            ? `${LIST_URL}?prgmId=XPG201040000`\r\n            : `${LIST_URL}?pageIndex=${page}`;\r\n\r\n        const html = await fetchHtml(url);\r\n        const $ = cheerio.load(html);\r\n\r\n        let pageCount = 0;\r\n\r\n        // div.table_box_wrap 기반 파싱\r\n        $(\"div.table_box_wrap\").each((_, wrap) => {\r\n            // 제목: p.subject > a > span.title\r\n            const titleEl = $(wrap).find(\"p.subject a\").first();\r\n            const title = $(wrap).find(\"p.subject span.title\").text().replace(/\\s+/g, \" \").trim();\r\n            if (!title || title.length < 3) return;\r\n\r\n            // ID: onclick=\"f_detail('I18835', '2026')\" 에서 추출\r\n            const onclick = titleEl.attr(\"onclick\") ?? \"\";\r\n            const idMatch = onclick.match(/f_detail\\(['\"]([\\w]+)['\"]/);\r\n            const articleId = idMatch ? idMatch[1] : $(wrap).find(\"p.no\").text().trim();\r\n\r\n            if (seen.has(articleId)) return;\r\n            seen.add(articleId);\r\n\r\n            // 날짜: .info 안의 label+value 쌍\r\n            let date = \"\";\r\n            let receiptStart = \"\";\r\n            let receiptEnd = \"\";\r\n\r\n            $(wrap).find(\"div.info p\").each((_, p) => {\r\n                const label = $(p).find(\"span.label\").text().trim();\r\n                const value = $(p).find(\"span.value\").text().trim();\r\n                if (label === \"등록일\") {\r\n                    date = value; // 이미 YYYY-MM-DD 형식\r\n                } else if (label === \"접수기간\") {\r\n                    // \"2026-02-06 09:00 ~ 2026-04-08 18:00\"\r\n                    const m = value.match(/(\\d{4}-\\d{2}-\\d{2}).*?~.*?(\\d{4}-\\d{2}-\\d{2})/);\r\n                    receiptStart = m ? m[1] : \"\";\r\n                    receiptEnd = m ? m[2] : \"\";\r\n                }\r\n            });\r\n\r\n            // 상세 URL: retrieveTaskAnncmInfoView.do?ancmId=I18835&bsnsYy=2026\r\n            const yearMatch = onclick.match(/f_detail\\(['\"][\\w]+['\"],\\s*['\"](\\d{4})['\"]/);\r\n            const year = yearMatch ? yearMatch[1] : \"\";\r\n            const source_url = articleId && year\r\n                ? `${BASE_URL}/srome/biz/perform/opnnPrpsl/retrieveTaskAnncmInfoView.do?ancmId=${articleId}&bsnsYy=${year}&prgmId=XPG201040000`\r\n                : `${LIST_URL}?prgmId=XPG201040000`;\r\n\r\n            results.push({ articleId, title, date, receiptStart, receiptEnd, source_url });\r\n            pageCount++;\r\n        });\r\n\r\n        console.log(`[KeitScraper] 페이지 ${page}: ${pageCount}건`);\r\n        if (pageCount === 0) break;\r\n    }\r\n\r\n    return results;\r\n}\r\n\r\n\r\n// ── 전체 수집 파이프라인 ──────────────────────────────────────────────────────\r\nexport async function scrapeKeitAnnouncements(\r\n    maxPages: number = 1,\r\n): Promise<KeitAnnouncement[]> {\r\n    console.log(\"[KeitScraper] 수집 시작\");\r\n    try {\r\n        const results = await fetchKeitList(maxPages);\r\n        console.log(`[KeitScraper] 최종 수집: ${results.length}건`);\r\n        return results;\r\n    } catch (err: any) {\r\n        console.error(\"[KeitScraper] 수집 실패:\", err.message);\r\n        return [];\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 685, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/nara-scraper.ts"],"sourcesContent":["/**\r\n * 조달청 나라장터 Open API 스크래퍼\r\n * - 엔드포인트: https://apis.data.go.kr/1230000/ad/BidPublicInfoService/getBidPblancListInfoServc\r\n * - 조회구분: 1 (등록일시)\r\n * - 조회기간: D-1 00:00 ~ 오늘 23:59\r\n * - 업무유형: 용역 (계약방법 제한 없음)\r\n */\r\n\r\nexport type NaraAnnouncement = {\r\n    title: string;           // bidNtceNm\r\n    bidNtceNo: string;       // 입찰공고번호\r\n    announce_date: string;   // YYYY-MM-DD (등록일시)\r\n    source_url: string | null; // 나라장터 상세 URL (API bidNtceDtlUrl)\r\n    org_name: string;        // 공고기관명 (ntceInsttNm)\r\n    demand_org_name: string | null; // 수요기관명 (dminsttNm)\r\n    description: string;     // 간략 설명 (발주기관 + 계약방법)\r\n};\r\n\r\nconst API_BASE = \"https://apis.data.go.kr/1230000/ad/BidPublicInfoService/getBidPblancListInfoServc\";\r\n\r\n/** YYYYMMDDHHMM 포맷으로 변환 */\r\nfunction toApiDate(d: Date, endOfDay = false): string {\r\n    const y = d.getFullYear();\r\n    const m = String(d.getMonth() + 1).padStart(2, \"0\");\r\n    const day = String(d.getDate()).padStart(2, \"0\");\r\n    const hh = endOfDay ? \"23\" : \"00\";\r\n    const mm = endOfDay ? \"59\" : \"00\";\r\n    return `${y}${m}${day}${hh}${mm}`;\r\n}\r\n\r\n/** D-1 날짜 계산 */\r\nfunction getYesterday(): Date {\r\n    const d = new Date();\r\n    d.setDate(d.getDate() - 1);\r\n    return d;\r\n}\r\n\r\n/** 등록일시(YYYY/MM/DD HH:MM) → YYYY-MM-DD */\r\nfunction formatDate(raw: string | undefined): string {\r\n    if (!raw) return \"\";\r\n    const m = raw.match(/(\\d{4})[\\/\\-](\\d{2})[\\/\\-](\\d{2})/);\r\n    if (!m) return raw.slice(0, 10);\r\n    return `${m[1]}-${m[2]}-${m[3]}`;\r\n}\r\n\r\n\r\n\r\n/**\r\n * 나라장터 용역 입찰공고 수집\r\n * @param keywords 활성 키워드 목록 (하나라도 포함되면 수집). 빈 배열이면 전체 수집.\r\n */\r\nexport async function scrapeNaraAnnouncements(\r\n    keywords: string[] = []\r\n): Promise<NaraAnnouncement[]> {\r\n    const serviceKey = process.env.NARA_API_KEY;\r\n    if (!serviceKey) {\r\n        console.warn(\"[NaraScraper] NARA_API_KEY 환경변수가 없습니다. 스킵합니다.\");\r\n        return [];\r\n    }\r\n\r\n    const yesterday = getYesterday();\r\n    const today = new Date();\r\n    const inqryBgnDt = toApiDate(yesterday, false);  // D-1 00:00\r\n    const inqryEndDt = toApiDate(today, true);        // 오늘 23:59\r\n\r\n    const results: NaraAnnouncement[] = [];\r\n    let pageNo = 1;\r\n    const numOfRows = 100;\r\n\r\n    console.log(`[NaraScraper] 조회기간: ${inqryBgnDt} ~ ${inqryEndDt}`);\r\n\r\n    while (true) {\r\n        const params = new URLSearchParams({\r\n            serviceKey,\r\n            pageNo: String(pageNo),\r\n            numOfRows: String(numOfRows),\r\n            type: \"json\",\r\n            inqryDiv: \"1\",          // 등록일시\r\n            inqryBgnDt,\r\n            inqryEndDt,\r\n        });\r\n\r\n        const url = `${API_BASE}?${params.toString()}`;\r\n\r\n        let json: any;\r\n        try {\r\n            const res = await fetch(url, {\r\n                signal: AbortSignal.timeout(30_000),\r\n            });\r\n            if (!res.ok) {\r\n                console.error(`[NaraScraper] HTTP ${res.status}`);\r\n                break;\r\n            }\r\n            json = await res.json();\r\n        } catch (err: any) {\r\n            console.error(`[NaraScraper] 요청 실패: ${err.message}`);\r\n            break;\r\n        }\r\n\r\n        // API 응답 파싱\r\n        const header = json?.response?.header;\r\n        if (!header || header.resultCode !== \"00\") {\r\n            console.error(`[NaraScraper] API 오류: ${header?.resultMsg ?? JSON.stringify(json)}`);\r\n            break;\r\n        }\r\n\r\n        const body = json?.response?.body;\r\n        const totalCount: number = body?.totalCount ?? 0;\r\n        const items: any[] = body?.items ?? [];\r\n\r\n        if (!Array.isArray(items) || items.length === 0) break;\r\n\r\n        console.log(`[NaraScraper] 페이지 ${pageNo}: ${items.length}건 (전체 ${totalCount}건)`);\r\n\r\n        for (const item of items) {\r\n            const title: string = item.bidNtceNm ?? \"\";\r\n            if (!title) continue;\r\n\r\n            // 키워드 필터링\r\n            if (keywords.length > 0) {\r\n                const lower = title.toLowerCase();\r\n                const desc = ((item.ntceInsttNm ?? \"\") + \" \" + (item.dminsttNm ?? \"\")).toLowerCase();\r\n                const matched = keywords.some(\r\n                    (kw) => lower.includes(kw.toLowerCase()) || desc.includes(kw.toLowerCase())\r\n                );\r\n                if (!matched) continue;\r\n            }\r\n\r\n            const bidNtceNo: string = item.bidNtceNo ?? \"\";\r\n            const bidNtceOrd: string = item.bidNtceOrd ?? \"000\";\r\n            const announceDate = formatDate(item.rgstDt ?? item.bidNtceDt ?? \"\");\r\n            const orgName: string = item.ntceInsttNm ?? \"조달청\";  // 공고기관명\r\n            const demandOrgName: string | null = item.dminsttNm ?? null;  // 수요기관명\r\n            const contractMethod: string = item.cntrctMthdNm ?? \"\";\r\n            const description = `[${orgName}] ${contractMethod ? contractMethod + \" / \" : \"\"}입찰공고`;\r\n            // API 응답의 bidNtceDtlUrl 필드를 직접 사용 (2025년 나라장터 개편 대응)\r\n            const sourceUrl: string | null = item.bidNtceDtlUrl ?? item.bidNtceUrl ?? null;\r\n\r\n            results.push({\r\n                title,\r\n                bidNtceNo,\r\n                announce_date: announceDate,\r\n                source_url: sourceUrl,\r\n                org_name: orgName,\r\n                demand_org_name: demandOrgName,\r\n                description,\r\n            });\r\n        }\r\n\r\n        // 다음 페이지 여부\r\n        if (pageNo * numOfRows >= totalCount) break;\r\n        pageNo++;\r\n    }\r\n\r\n    console.log(`[NaraScraper] 최종 수집(키워드 필터 적용): ${results.length}건`);\r\n    return results;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 889, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/email.ts"],"sourcesContent":["import nodemailer from \"nodemailer\";\r\n\r\n\r\n// ── SMTP 트랜스포터 (hanbiro, SSL 465) ───────────────────────────────────────\r\nfunction createTransporter() {\r\n  const password = process.env.SMTP_PASSWORD;\r\n  const from = process.env.SMTP_FROM;\r\n  if (!password) throw new Error(\"SMTP_PASSWORD 환경변수가 설정되지 않았습니다.\");\r\n  if (!from) throw new Error(\"SMTP_FROM 환경변수가 설정되지 않았습니다.\");\r\n\r\n  return nodemailer.createTransport({\r\n    host: \"mtsco.hanbiro.net\",\r\n    port: 465,\r\n    secure: true,        // SSL\r\n    auth: {\r\n      user: from,\r\n      pass: password,\r\n    },\r\n  });\r\n}\r\n\r\n// ── 신규 공고 이메일 알림 ─────────────────────────────────────────────────────\r\nexport type NewAnnouncementItem = {\r\n  title: string;\r\n  org_name: string | null;\r\n  announce_date: string | null;\r\n  category: string | null;\r\n  source_url: string | null;\r\n};\r\n\r\nexport async function sendNewAnnouncementsEmail(\r\n  items: NewAnnouncementItem[],\r\n  keywords: string[] = []\r\n): Promise<void> {\r\n  if (items.length === 0) return;\r\n\r\n  const from = process.env.SMTP_FROM;\r\n  const to = process.env.SMTP_TO;\r\n  if (!from || !to) throw new Error(\"SMTP_FROM 또는 SMTP_TO 환경변수가 설정되지 않았습니다.\");\r\n\r\n  const transporter = createTransporter();\r\n\r\n  // ── 카테고리 뱃지 ─────────────────────────────────────────────────────────────\r\n  const categoryBadge = (cat: string | null) => {\r\n    const map: Record<string, { bg: string; color: string }> = {\r\n      \"입찰공고\": { bg: \"#1c3d9c\", color: \"#ffffff\" },\r\n      \"공모\": { bg: \"#166534\", color: \"#ffffff\" },\r\n      \"지원사업\": { bg: \"#92400e\", color: \"#ffffff\" },\r\n      \"조달\": { bg: \"#6b21a8\", color: \"#ffffff\" },\r\n    };\r\n    const c = cat ?? \"-\";\r\n    const s = map[c] ?? { bg: \"#475569\", color: \"#ffffff\" };\r\n    return `<span style=\"display:inline-block;padding:3px 10px;border-radius:4px;font-size:11px;font-weight:700;background-color:${s.bg};color:${s.color};white-space:nowrap;\">${c}</span>`;\r\n  };\r\n\r\n  // ── 기관명 → 약어 매핑 ──────────────────────────────────────────────────────\r\n  const ORG_ABBR: Record<string, string> = {\r\n    \"한국지능정보사회진흥원\": \"NIA\",\r\n    \"정보통신산업진흥원\": \"NIPA\",\r\n    \"정보통신기획평가원\": \"IITP\",\r\n    \"한국산업기술기획평가원\": \"KEIT\",\r\n    \"나라장터_입찰\": \"G2B\",\r\n  };\r\n\r\n  // ── 행 생성 ─────────────────────────────────────────────────────────────────\r\n  const rows = items.map((item, i) => {\r\n    const dateStr = item.announce_date ?? \"-\";\r\n    const orgLabel = item.org_name ? (ORG_ABBR[item.org_name] ?? item.org_name) : \"미상\";\r\n    const titleHtml = item.source_url\r\n      ? `<a href=\"${item.source_url}\" style=\"color:#1d4ed8;text-decoration:underline;font-weight:700;font-size:14px;line-height:1.6;letter-spacing:-0.01em;\">${item.title} <span style=\"font-size:12px;\">↗</span></a>`\r\n      : `<span style=\"color:#1e293b;font-weight:700;font-size:14px;line-height:1.6;\">${item.title}</span>`;\r\n    const rowBg = i % 2 === 0 ? \"#ffffff\" : \"#f9fafb\";\r\n\r\n    return `<tr style=\"background-color:${rowBg};\">\r\n      <td style=\"padding:14px 0;border-bottom:1px solid #edf0f7;text-align:center;vertical-align:middle;width:40px;color:#3a4a6b;font-size:12px;font-weight:700;\">${i + 1}</td>\r\n      <td style=\"padding:14px 8px;border-bottom:1px solid #edf0f7;vertical-align:top;\">${titleHtml}</td>\r\n      <td style=\"padding:14px 10px;border-bottom:1px solid #edf0f7;font-size:12px;color:#1e293b;white-space:nowrap;vertical-align:middle;font-weight:600;width:80px;text-align:center;\">${orgLabel}</td>\r\n      <td style=\"padding:14px 16px 14px 8px;border-bottom:1px solid #edf0f7;white-space:nowrap;vertical-align:middle;font-size:12px;color:#1e293b;font-weight:600;width:110px;text-align:center;\">${dateStr}</td>\r\n    </tr>`;\r\n  }).join(\"\");\r\n\r\n  // ── 날짜 ────────────────────────────────────────────────────────────────────\r\n  const dateLabel = new Date().toLocaleDateString(\"ko-KR\", {\r\n    year: \"numeric\", month: \"long\", day: \"numeric\", weekday: \"long\",\r\n  });\r\n  const shortDate = new Date().toLocaleDateString(\"ko-KR\", { month: \"long\", day: \"numeric\" });\r\n\r\n  const html = `<!DOCTYPE html>\r\n<html lang=\"ko\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\r\n  <title>신규 사업공고 알림</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#eef1f7;font-family:'Apple SD Gothic Neo','Malgun Gothic',Arial,sans-serif;\">\r\n<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#eef1f7;\">\r\n<tr><td align=\"center\" style=\"padding:24px 16px 40px;\">\r\n<table width=\"620\" cellpadding=\"0\" cellspacing=\"0\" style=\"max-width:620px;width:100%;\">\r\n\r\n  <!-- ══ 상단 브랜드바 ══ -->\r\n  <tr><td style=\"padding:0 0 12px;\">\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\"><tr>\r\n      <td>\r\n        <table cellpadding=\"0\" cellspacing=\"0\"><tr>\r\n          <td style=\"font-size:13px;font-weight:700;color:#1c3d9c;letter-spacing:-0.01em;\">에이마비서</td>\r\n          <td style=\"padding:0 10px;\"><span style=\"display:inline-block;width:1px;height:14px;background-color:#c0c8d8;vertical-align:middle;\"></span></td>\r\n          <td style=\"font-size:10px;color:#8a96aa;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;\">Business Announcement Alert</td>\r\n        </tr></table>\r\n      </td>\r\n    </tr></table>\r\n  </td></tr>\r\n\r\n  <!-- ══ 메인 카드 ══ -->\r\n  <tr><td style=\"border-radius:8px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.10);\">\r\n\r\n    <!-- ① 헤더 (파란 배경) -->\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#1c3d9c;\">\r\n      <tr>\r\n        <td style=\"padding:22px 28px 0 28px;\">\r\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\"><tr>\r\n            <td style=\"vertical-align:top;\">\r\n              <p style=\"margin:0 0 6px;font-size:10px;font-weight:700;color:#a0b4e8;letter-spacing:0.1em;text-transform:uppercase;\">&#128203; NEW BUSINESS ANNOUNCEMENTS</p>\r\n              <h1 style=\"margin:0;font-size:22px;font-weight:900;color:#ffffff;line-height:1.25;letter-spacing:-0.02em;\">신규 사업공고<br>알림 리포트</h1>\r\n              <p style=\"margin:8px 0 0;font-size:12px;color:#a0b4e8;\">${dateLabel}</p>\r\n            </td>\r\n            <td style=\"vertical-align:top;text-align:right;padding-left:20px;\">\r\n              <table cellpadding=\"0\" cellspacing=\"0\" style=\"margin-left:auto;background-color:#162e7a;border-radius:6px;overflow:hidden;min-width:100px;\">\r\n                <tr><td style=\"padding:10px 16px;text-align:center;\">\r\n                  <div style=\"font-size:38px;font-weight:900;color:#f5a623;line-height:1;letter-spacing:-2px;\">${items.length}</div>\r\n                  <div style=\"font-size:10px;color:#a0b4e8;margin-top:4px;\">건의 신규 공고</div>\r\n                </td></tr>\r\n              </table>\r\n            </td>\r\n          </tr></table>\r\n        </td>\r\n      </tr>\r\n      <!-- 키워드 + 기관 -->\r\n      <tr>\r\n        <td style=\"padding:14px 28px 20px;\">\r\n          <table cellpadding=\"0\" cellspacing=\"0\" style=\"width:100%;\">\r\n            <tr>\r\n              <td>\r\n                <p style=\"margin:0 0 6px;font-size:12px;font-weight:600;color:#e0e8ff;line-height:1.8;\">\r\n                  <span style=\"color:#a0b4e8;font-weight:700;margin-right:6px;\">키워드 :</span>${keywords.length > 0 ? keywords.join(\"  \") : `<span style=\"color:#6a80b0;\">등록된 키워드 없음</span>`}\r\n                </p>\r\n                <p style=\"margin:0;font-size:12px;font-weight:600;color:#e0e8ff;line-height:1.8;\">\r\n                  <span style=\"color:#a0b4e8;font-weight:700;margin-right:6px;\">수집기관 :</span>NIA &nbsp;·&nbsp; NIPA &nbsp;·&nbsp; IITP &nbsp;·&nbsp; KEIT &nbsp;·&nbsp; G2B\r\n                </p>\r\n              </td>\r\n            </tr>\r\n          </table>\r\n        </td>\r\n      </tr>\r\n    </table>\r\n\r\n    <!-- ③ 헤더 + 공고 행 (단일 테이블) -->\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;\">\r\n      <colgroup>\r\n        <col style=\"width:40px;\">\r\n        <col style=\"width:auto;\">\r\n        <col style=\"width:150px;\">\r\n        <col style=\"width:110px;\">\r\n      </colgroup>\r\n      <thead style=\"background-color:#f0f2f7;border-top:1px solid #dde2ef;\">\r\n        <tr>\r\n          <th style=\"padding:10px 0;font-size:11px;font-weight:700;color:#6b7897;text-align:center;\">#</th>\r\n          <th style=\"padding:10px 8px;font-size:11px;font-weight:700;color:#3a4a6b;text-align:center;letter-spacing:0.05em;\">공&nbsp;&nbsp;고&nbsp;&nbsp;명</th>\r\n          <th style=\"padding:10px 10px;font-size:11px;font-weight:700;color:#3a4a6b;text-align:center;white-space:nowrap;\">기관</th>\r\n          <th style=\"padding:10px 16px 10px 8px;font-size:11px;font-weight:700;color:#3a4a6b;text-align:center;white-space:nowrap;\">공고날짜</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        ${rows}\r\n      </tbody>\r\n    </table>\r\n\r\n    <!-- ⑥ 푸터 -->\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f7f9fc;border-top:1px solid #e2e8f0;\">\r\n      <tr>\r\n        <td style=\"padding:18px 24px;\">\r\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\r\n            <tr>\r\n              <td>\r\n                <p style=\"margin:0;font-size:12px;color:#6b7897;line-height:1.8;\">\r\n                  본 메일은 <strong style=\"color:#1c3d9c;\">에이마비서</strong>의 사업공고 자동 수집 시스템이 발송했습니다.<br>\r\n                  수신 거부 · 문의: 관리자에게 연락하세요.\r\n                </p>\r\n              </td>\r\n              <td style=\"text-align:right;vertical-align:middle;padding-left:16px;\">\r\n                <div style=\"display:inline-block;background-color:#1c3d9c;border-radius:6px;padding:8px 16px;text-align:center;\">\r\n                  <div style=\"font-size:12px;font-weight:700;color:#ffffff;\">에이마비서</div>\r\n                </div>\r\n              </td>\r\n            </tr>\r\n          </table>\r\n        </td>\r\n      </tr>\r\n    </table>\r\n\r\n  </td></tr><!-- /메인 카드 -->\r\n\r\n</table>\r\n</td></tr>\r\n</table>\r\n</body>\r\n</html>`;\r\n\r\n  // 수신자 목록을 콤마로 분리하여 각각 개별 발송\r\n  const recipients = to.split(\",\").map(addr => addr.trim()).filter(Boolean);\r\n\r\n  for (const recipient of recipients) {\r\n    await transporter.sendMail({\r\n      from: `\"에이마비서 알림\" <${from}>`,\r\n      to: recipient,\r\n      subject: `[사업공고] 신규 ${items.length}건 - ${new Date().toLocaleDateString(\"ko-KR\")}`,\r\n      html,\r\n    });\r\n    console.log(`[Email] 신규 공고 ${items.length}건 이메일 발송 완료 → ${recipient}`);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1111, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/rfp-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\nimport { createClient, SupabaseClient } from \"@supabase/supabase-js\";\r\nimport { scrapeNiaAnnouncements } from \"./nia-scraper\";\r\nimport { scrapeNipaAnnouncements } from \"./nipa-scraper\";\r\nimport { scrapeIitpAnnouncements } from \"./iitp-scraper\";\r\nimport { scrapeKeitAnnouncements } from \"./keit-scraper\";\r\nimport { scrapeNaraAnnouncements } from \"./nara-scraper\";\r\nimport { sendNewAnnouncementsEmail, NewAnnouncementItem } from \"./email\";\r\n\r\n// ── Supabase Admin Client (service_role 우선, 없으면 anon key 폴백) ──────────\r\nfunction getAdminClient() {\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n    // rfp_announcements는 RLS disabled이므로 anon key로도 INSERT 가능\r\n    const key =\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY &&\r\n            process.env.SUPABASE_SERVICE_ROLE_KEY !== \"your-service-role-key-here\"\r\n            ? process.env.SUPABASE_SERVICE_ROLE_KEY\r\n            : process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n    return createClient(url, key, { auth: { persistSession: false } });\r\n}\r\n\r\n// ── 타입 ─────────────────────────────────────────────────────────────────────\r\nexport type CollMeth = \"API\" | \"RSS\" | \"Static Scraper\" | \"Dynamic Scraper\";\r\n\r\nexport type PublicOrg = {\r\n    id: number;\r\n    org_name: string;\r\n    org_type: string | null;\r\n    homepage_url: string | null;\r\n    rfp_url: string | null;\r\n    coll_meth: CollMeth | null;\r\n    is_active: boolean;\r\n};\r\n\r\nexport type ScrapedAnnouncement = {\r\n    title: string;\r\n    category?: string;\r\n    announce_date?: string | null;   // ISO date string\r\n    description?: string | null;\r\n    source_url?: string | null;\r\n    org_name?: string | null;        // 발주기관명 (나라장터 등 멀티기관 API에서 사용)\r\n    demand_org_name?: string | null; // 수요기관명 (나라장터 dminsttNm)\r\n};\r\n\r\nexport type ScrapeOrgResult = {\r\n    org_id: number;\r\n    org_name: string;\r\n    status: \"success\" | \"skipped\" | \"error\";\r\n    inserted: number;\r\n    skipped: number;\r\n    error?: string;\r\n    newItems?: NewAnnouncementItem[];  // 신규 공고 목록 (이메일용)\r\n};\r\n\r\n// ── unique_key 생성 (단방향 해시 없이 결정적 문자열로 처리) ─────────────────\r\nfunction buildUniqueKey(orgId: number, title: string, announce_date: string | null | undefined): string {\r\n    const d = announce_date ?? \"no-deadline\";\r\n    // Node.js crypto 없이 간단한 결정적 키 생성 (서버리스 환경 호환)\r\n    return `${orgId}::${title.trim().toLowerCase()}::${d}`;\r\n}\r\n\r\n// ── 정적 스크래퍼 (Cheerio) ──────────────────────────────────────────────────\r\nexport class StaticScraper {\r\n    private readonly userAgent =\r\n        \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\n    async scrape(rfpUrl: string): Promise<ScrapedAnnouncement[]> {\r\n        const html = await this.fetchHtml(rfpUrl);\r\n        const $ = cheerio.load(html);\r\n        const results: ScrapedAnnouncement[] = [];\r\n\r\n        // ── 전략 1: table 기반 목록 ─────────────────────────────────────────\r\n        const tableRows = $(\"table tbody tr, table tr\").toArray();\r\n        if (tableRows.length > 0) {\r\n            for (const row of tableRows) {\r\n                const cells = $(row).find(\"td\");\r\n                if (cells.length < 2) continue;\r\n\r\n                const titleEl = $(row).find(\"td a\").first();\r\n                const title = titleEl.text().trim() || $(cells.get(0)).text().trim();\r\n                if (!title || title.length < 2) continue;\r\n\r\n                const href = titleEl.attr(\"href\");\r\n                const source_url = href\r\n                    ? href.startsWith(\"http\") ? href : new URL(href, rfpUrl).href\r\n                    : null;\r\n\r\n                // 날짜 패턴 찾기 (YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD)\r\n                const rowText = $(row).text();\r\n                const announce_date = this.extractDate(rowText);\r\n\r\n                results.push({ title, source_url, announce_date, description: null });\r\n            }\r\n        }\r\n\r\n        // ── 전략 2: list item 기반 ──────────────────────────────────────────\r\n        if (results.length === 0) {\r\n            const listItems = $(\r\n                \"ul li a, .list-item a, .bbs-list a, .board-list a, .notice-list a, article a\"\r\n            ).toArray();\r\n\r\n            for (const el of listItems) {\r\n                const title = $(el).text().trim();\r\n                if (!title || title.length < 3) continue;\r\n\r\n                const href = $(el).attr(\"href\");\r\n                const source_url = href\r\n                    ? href.startsWith(\"http\") ? href : new URL(href, rfpUrl).href\r\n                    : null;\r\n\r\n                const parentText = $(el).parent().text();\r\n                const announce_date = this.extractDate(parentText);\r\n\r\n                results.push({ title, source_url, announce_date, description: null });\r\n            }\r\n        }\r\n\r\n        // ── 전략 3: RSS/Atom feed XML ────────────────────────────────────────\r\n        if (results.length === 0 && (rfpUrl.includes(\"rss\") || rfpUrl.includes(\"feed\") || rfpUrl.includes(\"atom\"))) {\r\n            $(\"item, entry\").each((_, el) => {\r\n                const title = $(el).find(\"title\").text().trim();\r\n                if (!title) return;\r\n\r\n                const source_url = $(el).find(\"link\").text().trim() ||\r\n                    $(el).find(\"link\").attr(\"href\") || null;\r\n                const pubDate = $(el).find(\"pubDate, published, updated\").text().trim();\r\n                const description = $(el).find(\"description, summary, content\").text().trim() || null;\r\n                const announce_date = this.extractDate(pubDate || \"\");\r\n\r\n                results.push({ title, source_url, announce_date, description });\r\n            });\r\n        }\r\n\r\n        return results.slice(0, 100); // 최대 100개 제한\r\n    }\r\n\r\n    private async fetchHtml(url: string): Promise<string> {\r\n        const res = await fetch(url, {\r\n            headers: { \"User-Agent\": this.userAgent },\r\n            signal: AbortSignal.timeout(20_000), // 20초 타임아웃\r\n        });\r\n        if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);\r\n        return res.text();\r\n    }\r\n\r\n    /** 텍스트에서 YYYY-MM-DD / YYYY.MM.DD / YYYY/MM/DD 패턴 추출 */\r\n    private extractDate(text: string): string | null {\r\n        const match = text.match(/(\\d{4})[-./](\\d{1,2})[-./](\\d{1,2})/);\r\n        if (!match) return null;\r\n        const [, y, m, d] = match;\r\n        return `${y}-${m.padStart(2, \"0\")}-${d.padStart(2, \"0\")}`;\r\n    }\r\n}\r\n\r\n// ── 동적 스크래퍼 Stub ───────────────────────────────────────────────────────\r\nexport class DynamicScraperStub {\r\n    async scrape(rfpUrl: string, orgName: string): Promise<ScrapedAnnouncement[]> {\r\n        console.warn(\r\n            `[RfpScraper] Dynamic Scraper not available in serverless env. ` +\r\n            `Skipping ${orgName} (${rfpUrl}). ` +\r\n            `To enable: integrate BrowserBase or ScrapingBee API.`\r\n        );\r\n        return [];\r\n    }\r\n}\r\n\r\n// ── 메인 오케스트레이터 ──────────────────────────────────────────────────────\r\nexport class RfpScraper {\r\n    private staticScraper = new StaticScraper();\r\n    private dynamicScraper = new DynamicScraperStub();\r\n\r\n    /** NIA(한국지능정보사회진흥원) URL 패턴 감지 */\r\n    private isNiaUrl(url: string): boolean {\r\n        return url.includes(\"nia.or.kr\") && url.includes(\"cbIdx=78336\");\r\n    }\r\n\r\n    /** NIPA(정보통신산업진흥원) URL 패턴 감지 */\r\n    private isNipaUrl(url: string): boolean {\r\n        return url.includes(\"nipa.kr\");\r\n    }\r\n\r\n    /** IITP(정보통신기획평가원) URL 패턴 감지 */\r\n    private isIitpUrl(url: string): boolean {\r\n        return url.includes(\"iitp.kr\");\r\n    }\r\n\r\n    /** KEIT(한국산업기술기획평가원) URL 패턴 감지 */\r\n    private isKeitUrl(url: string): boolean {\r\n        return url.includes(\"keit.re.kr\");\r\n    }\r\n\r\n    /** 나라장터(조달청) 기관명 감지 */\r\n    private isNaraOrg(orgName: string): boolean {\r\n        return orgName.includes(\"나라장터\") || orgName.includes(\"조달청\");\r\n    }\r\n\r\n    async run(): Promise<ScrapeOrgResult[]> {\r\n        const supabase = getAdminClient();\r\n        const results: ScrapeOrgResult[] = [];\r\n\r\n        // 1. 활성 필터링 키워드 목록 조회\r\n        const { data: keywordRows } = await supabase\r\n            .from(\"rfp_filter_keywords\")\r\n            .select(\"keyword\")\r\n            .eq(\"is_active\", true);\r\n\r\n        const filterKeywords: string[] = (keywordRows ?? []).map((r: any) =>\r\n            (r.keyword as string).toLowerCase()\r\n        );\r\n\r\n        if (filterKeywords.length > 0) {\r\n            console.log(`[RfpScraper] 필터링 키워드 ${filterKeywords.length}개 적용: ${filterKeywords.join(\", \")}`);\r\n        } else {\r\n            console.log(\"[RfpScraper] 필터링 키워드 없음 — 전체 수집 모드\");\r\n        }\r\n\r\n        // 2. 수집 활성화된 기관 목록 조회\r\n        const { data: orgs, error: orgsErr } = await supabase\r\n            .from(\"rfp_public_org\")\r\n            .select(\"id, org_name, org_type, homepage_url, rfp_url, coll_meth, is_active\")\r\n            .eq(\"is_active\", true);\r\n\r\n        if (orgsErr) {\r\n            console.error(\"[RfpScraper] Failed to fetch orgs:\", orgsErr.message);\r\n            return [{ org_id: 0, org_name: \"N/A\", status: \"error\", inserted: 0, skipped: 0, error: orgsErr.message }];\r\n        }\r\n\r\n        if (!orgs || orgs.length === 0) {\r\n            console.log(\"[RfpScraper] No active orgs found.\");\r\n            return [];\r\n        }\r\n\r\n        console.log(`[RfpScraper] Processing ${orgs.length} active orgs`);\r\n\r\n        // 3. 기관별 수집\r\n        for (const org of orgs as PublicOrg[]) {\r\n            const result = await this.scrapeOrg(supabase, org, filterKeywords);\r\n            results.push(result);\r\n            console.log(\r\n                `[RfpScraper] ${org.org_name}: ${result.status} ` +\r\n                `(inserted=${result.inserted}, skipped=${result.skipped})`\r\n            );\r\n        }\r\n\r\n        // 4. 신규 공고가 있으면 이메일 발송\r\n        const allNewItems: NewAnnouncementItem[] = results.flatMap((r) => r.newItems ?? []);\r\n        if (allNewItems.length > 0) {\r\n            try {\r\n                // 활성 키워드 조회\r\n                const { data: kwData } = await getAdminClient()\r\n                    .from(\"rfp_filter_keywords\")\r\n                    .select(\"keyword\")\r\n                    .eq(\"is_active\", true)\r\n                    .order(\"id\", { ascending: true });\r\n                const activeKeywords = (kwData ?? []).map((k: any) => k.keyword);\r\n                await sendNewAnnouncementsEmail(allNewItems, activeKeywords);\r\n            } catch (mailErr: any) {\r\n                console.error(\"[RfpScraper] 이메일 발송 실패:\", mailErr.message);\r\n            }\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /** 제목 또는 설명에 활성 필터링 키워드가 하나라도 포함되는지 검사 */\r\n    private matchesKeywords(ann: ScrapedAnnouncement, keywords: string[]): boolean {\r\n        if (keywords.length === 0) return true; // 키워드 없으면 전체 통과\r\n        const haystack = [\r\n            ann.title ?? \"\",\r\n            ann.description ?? \"\",\r\n        ].join(\" \").toLowerCase();\r\n        return keywords.some((kw) => haystack.includes(kw));\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private async scrapeOrg(supabase: SupabaseClient<any, any, any>, org: PublicOrg, filterKeywords: string[] = []): Promise<ScrapeOrgResult> {\r\n        const base: ScrapeOrgResult = {\r\n            org_id: org.id,\r\n            org_name: org.org_name,\r\n            status: \"success\",\r\n            inserted: 0,\r\n            skipped: 0,\r\n        };\r\n\r\n        if (!org.rfp_url && !this.isNaraOrg(org.org_name)) {\r\n            return { ...base, status: \"skipped\", error: \"rfp_url 없음\" };\r\n        }\r\n\r\n        // 3. 엔진 분기: URL 패턴 우선 → coll_meth 순서로 결정\r\n        let announcements: ScrapedAnnouncement[] = [];\r\n        try {\r\n            if (this.isNaraOrg(org.org_name)) {\r\n                // 나라장터(조달청): Open API 사용 — rfp_url 불필요\r\n                const naraResults = await scrapeNaraAnnouncements(\r\n                    filterKeywords.length > 0 ? filterKeywords : []\r\n                );\r\n                announcements = naraResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"입찰공고\",\r\n                    announce_date: r.announce_date || null,\r\n                    description: r.description,\r\n                    source_url: r.source_url,\r\n                    org_name: r.org_name || null,      // 공고기관명 (ntceInsttNm)\r\n                    demand_org_name: r.demand_org_name || null,  // 수요기관명 (dminsttNm)\r\n                }));\r\n            } else if (org.coll_meth === \"Dynamic Scraper\") {\r\n                announcements = await this.dynamicScraper.scrape(org.rfp_url!, org.org_name);\r\n            } else if (this.isNiaUrl(org.rfp_url!)) {\r\n                // NIA(한국지능정보사회진흥원): 전용 스크래퍼 사용\r\n                const niaResults = await scrapeNiaAnnouncements(1, true);\r\n                announcements = niaResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"입찰공고\",\r\n                    announce_date: r.date || null,\r\n                    description: r.content?.slice(0, 2000) || null,\r\n                    source_url: r.source_url,\r\n                }));\r\n            } else if (this.isNipaUrl(org.rfp_url!)) {\r\n                // NIPA(정보통신산업진흥원): 전용 스크래퍼 사용\r\n                const nipaResults = await scrapeNipaAnnouncements(1, true);\r\n                announcements = nipaResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"공고\",\r\n                    announce_date: r.date || null,\r\n                    description: r.content?.slice(0, 2000) || null,\r\n                    source_url: r.source_url,\r\n                }));\r\n            } else if (this.isIitpUrl(org.rfp_url!)) {\r\n                // IITP(정보통신기획평가원): 전용 스크래퍼 사용\r\n                const iitpResults = await scrapeIitpAnnouncements(20);\r\n                announcements = iitpResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"입찰공고\",\r\n                    announce_date: r.date || null,\r\n                    description: r.content?.slice(0, 2000) || null,\r\n                    source_url: r.source_url,\r\n                }));\r\n            } else if (this.isKeitUrl(org.rfp_url!)) {\r\n                // KEIT(한국산업기술기획평가원): 전용 스크래퍼 사용\r\n                const keitResults = await scrapeKeitAnnouncements(1);\r\n                announcements = keitResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"공고\",\r\n                    announce_date: r.date || null,\r\n                    description: r.receiptEnd\r\n                        ? `접수기간: ${r.receiptStart} ~ ${r.receiptEnd}`\r\n                        : null,\r\n                    source_url: r.source_url,\r\n                }));\r\n            } else if (this.isNaraOrg(org.org_name)) {\r\n                // 나라장터(조달청): Open API 사용 (키워드 내부 적용)\r\n                const naraResults = await scrapeNaraAnnouncements(\r\n                    filterKeywords.length > 0 ? filterKeywords : []\r\n                );\r\n                announcements = naraResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"입찰공고\",\r\n                    announce_date: r.announce_date || null,\r\n                    description: r.description,\r\n                    source_url: r.source_url,\r\n                }));\r\n            } else {\r\n                // 범용 Cheerio 스크래퍼 (table/list/RSS 전략)\r\n                announcements = await this.staticScraper.scrape(org.rfp_url!);\r\n            }\r\n        } catch (err: any) {\r\n            return { ...base, status: \"error\", error: err.message };\r\n        }\r\n\r\n        if (announcements.length === 0) {\r\n            return { ...base, status: \"skipped\", error: \"공고 없음 (파싱 결과 0건)\" };\r\n        }\r\n\r\n        // 4. 필터링 키워드 적용\r\n        const filtered = announcements.filter((ann) => this.matchesKeywords(ann, filterKeywords));\r\n        console.log(\r\n            `[RfpScraper] ${org.org_name}: 수집 ${announcements.length}건 → 키워드 필터 후 ${filtered.length}건`\r\n        );\r\n\r\n        if (filtered.length === 0) {\r\n            return { ...base, status: \"skipped\", error: \"키워드 매칭 결과 0건\" };\r\n        }\r\n\r\n        // 5. 증분 저장 (unique_key 기준 → 신규만 INSERT)\r\n        let inserted = 0;\r\n        let skipped = 0;\r\n        const newItems: NewAnnouncementItem[] = [];\r\n\r\n        for (const ann of filtered) {\r\n            if (!ann.title?.trim()) continue;\r\n\r\n            const unique_key = buildUniqueKey(org.id, ann.title, ann.announce_date);\r\n\r\n            const row = {\r\n                org_id: org.id,\r\n                unique_key,\r\n                title: ann.title.trim(),\r\n                category: ann.category ?? org.org_type ?? null,\r\n                announce_date: ann.announce_date ?? null,\r\n                description: ann.description ?? null,\r\n                source_url: ann.source_url ?? null,\r\n                org_name: ann.org_name ?? null,          // 공고기관명 (ntceInsttNm)\r\n                demand_org_name: ann.demand_org_name ?? null, // 수요기관명 (dminsttNm)\r\n                is_active: true,\r\n                scraped_at: new Date().toISOString(),\r\n            };\r\n\r\n            // 증분 수집: unique_key 중복 여부 먼저 확인\r\n            const { data: existing } = await supabase\r\n                .from(\"rfp_announcements\")\r\n                .select(\"id\")\r\n                .eq(\"unique_key\", unique_key)\r\n                .maybeSingle();\r\n\r\n            if (existing) {\r\n                skipped++;\r\n                continue;\r\n            }\r\n\r\n            const { error: insertErr } = await supabase\r\n                .from(\"rfp_announcements\")\r\n                .insert(row);\r\n\r\n            if (insertErr) {\r\n                console.error(`[RfpScraper] Insert error for \"${ann.title}\":`, insertErr.message);\r\n            } else {\r\n                inserted++;\r\n                // 이메일 발송용 신규 공고 누적\r\n                newItems.push({\r\n                    title: ann.title.trim(),\r\n                    org_name: org.org_name,\r\n                    announce_date: ann.announce_date ?? null,\r\n                    category: ann.category ?? null,\r\n                    source_url: ann.source_url ?? null,\r\n                });\r\n            }\r\n        }\r\n\r\n        return { ...base, inserted, skipped, newItems };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1484, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/app/api/cron/rfp-scrape/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { RfpScraper } from \"@/lib/services/rfp-scraper\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\nexport const maxDuration = 300; // Vercel Pro: 최대 5분 실행 허용\r\n\r\nexport async function GET(request: Request) {\r\n    // ── 보안: CRON_SECRET 검증 ─────────────────────────────────────────────\r\n    const authHeader = request.headers.get(\"authorization\");\r\n    const cronSecret = process.env.CRON_SECRET;\r\n\r\n    if (cronSecret && authHeader !== `Bearer ${cronSecret}`) {\r\n        console.warn(\"[rfp-scrape] Unauthorized cron request\");\r\n        return new NextResponse(\"Unauthorized\", { status: 401 });\r\n    }\r\n\r\n    const startedAt = new Date().toISOString();\r\n    console.log(`[rfp-scrape] Cron started at ${startedAt}`);\r\n\r\n    try {\r\n        const scraper = new RfpScraper();\r\n        const results = await scraper.run();\r\n\r\n        const totalInserted = results.reduce((s, r) => s + r.inserted, 0);\r\n        const totalSkipped = results.reduce((s, r) => s + r.skipped, 0);\r\n        const errors = results.filter((r) => r.status === \"error\");\r\n\r\n        console.log(\r\n            `[rfp-scrape] Done. inserted=${totalInserted}, skipped=${totalSkipped}, errors=${errors.length}`\r\n        );\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            startedAt,\r\n            completedAt: new Date().toISOString(),\r\n            summary: {\r\n                totalOrgs: results.length,\r\n                totalInserted,\r\n                totalSkipped,\r\n                totalErrors: errors.length,\r\n            },\r\n            results,\r\n        });\r\n    } catch (err: any) {\r\n        console.error(\"[rfp-scrape] Fatal error:\", err);\r\n        return NextResponse.json(\r\n            { success: false, error: err.message, startedAt },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAChB,MAAM,cAAc,KAAK,0BAA0B;AAEnD,eAAe,IAAI,OAAgB;IACtC,sEAAsE;IACtE,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,MAAM,aAAa,QAAQ,GAAG,CAAC,WAAW;IAE1C,IAAI,cAAc,eAAe,CAAC,OAAO,EAAE,YAAY,EAAE;QACrD,QAAQ,IAAI,CAAC;QACb,OAAO,IAAI,gJAAY,CAAC,gBAAgB;YAAE,QAAQ;QAAI;IAC1D;IAEA,MAAM,YAAY,IAAI,OAAO,WAAW;IACxC,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,WAAW;IAEvD,IAAI;QACA,MAAM,UAAU,IAAI,wJAAU;QAC9B,MAAM,UAAU,MAAM,QAAQ,GAAG;QAEjC,MAAM,gBAAgB,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,EAAE,QAAQ,EAAE;QAC/D,MAAM,eAAe,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,EAAE,OAAO,EAAE;QAC7D,MAAM,SAAS,QAAQ,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;QAElD,QAAQ,GAAG,CACP,CAAC,4BAA4B,EAAE,cAAc,UAAU,EAAE,aAAa,SAAS,EAAE,OAAO,MAAM,EAAE;QAGpG,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT;YACA,aAAa,IAAI,OAAO,WAAW;YACnC,SAAS;gBACL,WAAW,QAAQ,MAAM;gBACzB;gBACA;gBACA,aAAa,OAAO,MAAM;YAC9B;YACA;QACJ;IACJ,EAAE,OAAO,KAAU;QACf,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,SAAS;YAAO,OAAO,IAAI,OAAO;YAAE;QAAU,GAChD;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}