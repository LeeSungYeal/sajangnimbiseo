module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/node:stream [external] (node:stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/string_decoder [external] (string_decoder, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/node:assert [external] (node:assert, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:assert", () => require("node:assert"));

module.exports = mod;
}),
"[externals]/node:net [external] (node:net, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:net", () => require("node:net"));

module.exports = mod;
}),
"[externals]/node:http [external] (node:http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:http", () => require("node:http"));

module.exports = mod;
}),
"[externals]/node:querystring [external] (node:querystring, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:querystring", () => require("node:querystring"));

module.exports = mod;
}),
"[externals]/node:events [external] (node:events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:events", () => require("node:events"));

module.exports = mod;
}),
"[externals]/node:diagnostics_channel [external] (node:diagnostics_channel, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:diagnostics_channel", () => require("node:diagnostics_channel"));

module.exports = mod;
}),
"[externals]/node:util [external] (node:util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:util", () => require("node:util"));

module.exports = mod;
}),
"[externals]/node:tls [external] (node:tls, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:tls", () => require("node:tls"));

module.exports = mod;
}),
"[externals]/node:buffer [external] (node:buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:buffer", () => require("node:buffer"));

module.exports = mod;
}),
"[externals]/node:zlib [external] (node:zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:zlib", () => require("node:zlib"));

module.exports = mod;
}),
"[externals]/node:perf_hooks [external] (node:perf_hooks, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:perf_hooks", () => require("node:perf_hooks"));

module.exports = mod;
}),
"[externals]/node:util/types [external] (node:util/types, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:util/types", () => require("node:util/types"));

module.exports = mod;
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[externals]/node:worker_threads [external] (node:worker_threads, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:worker_threads", () => require("node:worker_threads"));

module.exports = mod;
}),
"[externals]/node:http2 [external] (node:http2, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:http2", () => require("node:http2"));

module.exports = mod;
}),
"[externals]/node:async_hooks [external] (node:async_hooks, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:async_hooks", () => require("node:async_hooks"));

module.exports = mod;
}),
"[externals]/node:console [external] (node:console, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:console", () => require("node:console"));

module.exports = mod;
}),
"[externals]/node:fs/promises [external] (node:fs/promises, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:fs/promises", () => require("node:fs/promises"));

module.exports = mod;
}),
"[externals]/node:path [external] (node:path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:path", () => require("node:path"));

module.exports = mod;
}),
"[externals]/node:timers [external] (node:timers, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:timers", () => require("node:timers"));

module.exports = mod;
}),
"[externals]/node:dns [external] (node:dns, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:dns", () => require("node:dns"));

module.exports = mod;
}),
"[project]/src/lib/services/nia-scraper.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "fetchNiaDetail",
    ()=>fetchNiaDetail,
    "fetchNiaList",
    ()=>fetchNiaList,
    "scrapeNiaAnnouncements",
    ()=>scrapeNiaAnnouncements
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$cheerio$2f$dist$2f$esm$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/cheerio/dist/esm/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$cheerio$2f$dist$2f$esm$2f$load$2d$parse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/cheerio/dist/esm/load-parse.js [app-route] (ecmascript)");
;
const BASE_URL = "https://www.nia.or.kr";
const LIST_URL = `${BASE_URL}/site/nia_kor/ex/bbs/List.do?cbIdx=78336`;
const DETAIL_URL = `${BASE_URL}/site/nia_kor/ex/bbs/View.do`;
const USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
// ── HTML fetch helper ─────────────────────────────────────────────────────────
async function fetchHtml(url) {
    const res = await fetch(url, {
        headers: {
            "User-Agent": USER_AGENT,
            "Referer": BASE_URL
        },
        signal: AbortSignal.timeout(20_000)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);
    return res.text();
}
// ── 날짜 정규화 (2026.02.24 → 2026-02-24) ────────────────────────────────────
function normalizeDate(raw) {
    const m = raw.trim().match(/(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})/);
    if (!m) return raw.trim();
    return `${m[1]}-${m[2].padStart(2, "0")}-${m[3].padStart(2, "0")}`;
}
async function fetchNiaList(maxPages = 1) {
    const items = [];
    for(let page = 1; page <= maxPages; page++){
        const url = page === 1 ? LIST_URL : `${LIST_URL}&pageIndex=${page}`;
        const html = await fetchHtml(url);
        const $ = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$cheerio$2f$dist$2f$esm$2f$load$2d$parse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["load"](html);
        // a[href="#view"] 기반으로 공고 항목 탐색 (ul.board-list 클래스 없음)
        $("a[href='#view']").each((_, anchor)=>{
            const onclick = $(anchor).attr("onclick") ?? "";
            // onclick: doBbsFView('78336','29066','16010100','29066');return false;
            const match = onclick.match(/doBbsFView\(\s*['"]?\d+['"]?\s*,\s*['"]?(\d+)['"]?/);
            if (!match) return;
            const bcIdx = match[1];
            // 제목: 첫 번째 span (new/첨부 아이콘 제외)
            const spans = $(anchor).find("span").toArray();
            const title = spans.map((s)=>$(s).clone().children().remove().end().text().trim()).filter((t)=>t.length > 3 && !/첨부|new|N/i.test(t)).join(" ").trim() || $(anchor).text().replace(/\s+/g, " ").trim().split(" ")[0];
            if (!title || title.length < 2) return;
            // 날짜: 같은 a 태그 내 em 또는 span > em에서 날짜 패턴
            const dateRaw = $(anchor).find("em").toArray().map((e)=>$(e).text().trim()).find((t)=>/\d{4}[.\-/]\d{1,2}[.\-/]\d{1,2}/.test(t)) ?? "";
            const date = normalizeDate(dateRaw);
            items.push({
                bcIdx,
                title,
                date
            });
        });
        if (items.length === 0 && page === 1) break;
    }
    return items;
}
async function fetchNiaDetail(bcIdx) {
    const url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${bcIdx}`;
    const html = await fetchHtml(url);
    const $ = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$cheerio$2f$dist$2f$esm$2f$load$2d$parse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["load"](html);
    // 날짜: .src em 또는 .type01_info em
    const dateRaw = $(".detail_type01 .src em, .type01_info .src em, .src em").first().text().trim() || $(".date, .reg_date").first().text().trim();
    const date = normalizeDate(dateRaw);
    // 본문: .con_area 내부 텍스트 (HTML태그 제거, 정제)
    const conArea = $(".detail_type01 .con_area, .con_area").first();
    const content = conArea.text().replace(/\s{3,}/g, "\n\n") // 연속 공백/줄바꿈 정리
    .trim();
    return {
        content,
        date
    };
}
async function scrapeNiaAnnouncements(maxPages = 1, fetchDetail = true) {
    const listItems = await fetchNiaList(maxPages);
    const results = [];
    for (const item of listItems){
        const source_url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${item.bcIdx}`;
        let content = "";
        let date = item.date;
        if (fetchDetail) {
            try {
                const detail = await fetchNiaDetail(item.bcIdx);
                content = detail.content;
                // 상세 페이지 날짜가 더 정확한 경우 사용
                if (detail.date) date = detail.date;
            } catch (e) {
                console.warn(`[NiaScraper] Detail fetch failed for bcIdx=${item.bcIdx}:`, e);
            }
        }
        results.push({
            bcIdx: item.bcIdx,
            title: item.title,
            date,
            content,
            source_url
        });
    }
    return results;
}
}),
"[project]/src/app/api/cron/nia-scrape/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "dynamic",
    ()=>dynamic,
    "maxDuration",
    ()=>maxDuration
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/index.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$services$2f$nia$2d$scraper$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/services/nia-scraper.ts [app-route] (ecmascript)");
;
;
;
const dynamic = "force-dynamic";
const maxDuration = 300;
const ORG_RFP_URL = "https://www.nia.or.kr/site/nia_kor/ex/bbs/List.do?cbIdx=78336";
// anon key fallback (RLS disabled on rfp_announcements)
function getSupabase() {
    const url = ("TURBOPACK compile-time value", "https://zrdcdkafvpbbcmyrzeku.supabase.co");
    const key = process.env.SUPABASE_SERVICE_ROLE_KEY && process.env.SUPABASE_SERVICE_ROLE_KEY !== "your-service-role-key-here" ? process.env.SUPABASE_SERVICE_ROLE_KEY : ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyZGNka2FmdnBiYmNteXJ6ZWt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTAyODAsImV4cCI6MjA4NDEyNjI4MH0.CvbveMYPBr-U5ktBFm8jgAt0DE3l9Xv6OuSZeQ9r9pQ");
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(url, key, {
        auth: {
            persistSession: false
        }
    });
}
async function GET(request) {
    // 보안 검증
    const authHeader = request.headers.get("authorization");
    const cronSecret = process.env.CRON_SECRET;
    if (cronSecret && authHeader !== `Bearer ${cronSecret}`) {
        return new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"]("Unauthorized", {
            status: 401
        });
    }
    const startedAt = new Date().toISOString();
    const supabase = getSupabase();
    try {
        // 1. rfp_public_org에서 NIA 기관 ID 조회 (rfp_url로 매핑)
        const { data: org } = await supabase.from("rfp_public_org").select("id, org_name").eq("rfp_url", ORG_RFP_URL).maybeSingle();
        const orgId = org?.id ?? 0; // 미등록이면 0 (테스트용)
        const orgName = org?.org_name ?? "한국지능정보사회진흥원(NIA)";
        console.log(`[nia-scrape] Start scraping for ${orgName} (org_id=${orgId})`);
        // 2. NIA 공고 수집 (최신 1페이지 = 10건)
        const announcements = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$services$2f$nia$2d$scraper$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["scrapeNiaAnnouncements"])(1, true);
        console.log(`[nia-scrape] Fetched ${announcements.length} announcements`);
        let inserted = 0;
        let skipped = 0;
        const errors = [];
        // 3. DB 증분 저장
        for (const ann of announcements){
            const unique_key = `${orgId}::nia::${ann.bcIdx}`;
            // 중복 체크
            const { data: existing } = await supabase.from("rfp_announcements").select("id").eq("unique_key", unique_key).maybeSingle();
            if (existing) {
                skipped++;
                continue;
            }
            const { error } = await supabase.from("rfp_announcements").insert({
                org_id: orgId || null,
                unique_key,
                title: ann.title,
                category: "입찰공고",
                deadline: ann.date || null,
                description: ann.content?.slice(0, 2000) || null,
                source_url: ann.source_url,
                is_active: true,
                scraped_at: new Date().toISOString()
            });
            if (error) {
                console.error(`[nia-scrape] Insert error:`, error.message);
                errors.push(`${ann.title}: ${error.message}`);
            } else {
                inserted++;
            }
        }
        console.log(`[nia-scrape] Done. inserted=${inserted}, skipped=${skipped}, errors=${errors.length}`);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            startedAt,
            completedAt: new Date().toISOString(),
            org: orgName,
            summary: {
                fetched: announcements.length,
                inserted,
                skipped,
                errors: errors.length
            },
            errorDetails: errors
        });
    } catch (err) {
        console.error("[nia-scrape] Fatal:", err);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: false,
            error: err.message,
            startedAt
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__df8f5ad9._.js.map