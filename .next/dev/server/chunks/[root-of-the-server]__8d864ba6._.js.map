{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/nia-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\n\r\nconst BASE_URL = \"https://www.nia.or.kr\";\r\nconst LIST_URL = `${BASE_URL}/site/nia_kor/ex/bbs/List.do?cbIdx=78336`;\r\nconst DETAIL_URL = `${BASE_URL}/site/nia_kor/ex/bbs/View.do`;\r\n\r\nconst USER_AGENT =\r\n    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\nexport type NiaAnnouncement = {\r\n    bcIdx: string;\r\n    title: string;\r\n    date: string;          // YYYY-MM-DD\r\n    content: string;\r\n    source_url: string;\r\n};\r\n\r\n// ── HTML fetch helper ─────────────────────────────────────────────────────────\r\nasync function fetchHtml(url: string): Promise<string> {\r\n    const res = await fetch(url, {\r\n        headers: {\r\n            \"User-Agent\": USER_AGENT,\r\n            \"Referer\": BASE_URL,\r\n        },\r\n        signal: AbortSignal.timeout(20_000),\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);\r\n    return res.text();\r\n}\r\n\r\n// ── 날짜 정규화 (2026.02.24 → 2026-02-24) ────────────────────────────────────\r\nfunction normalizeDate(raw: string): string {\r\n    const m = raw.trim().match(/(\\d{4})[.\\-/](\\d{1,2})[.\\-/](\\d{1,2})/);\r\n    if (!m) return raw.trim();\r\n    return `${m[1]}-${m[2].padStart(2, \"0\")}-${m[3].padStart(2, \"0\")}`;\r\n}\r\n\r\n// ── 목록 페이지에서 bcIdx 목록 추출 ──────────────────────────────────────────\r\nexport async function fetchNiaList(maxPages: number = 1): Promise<Array<{ bcIdx: string; title: string; date: string }>> {\r\n    const items: Array<{ bcIdx: string; title: string; date: string }> = [];\r\n\r\n    for (let page = 1; page <= maxPages; page++) {\r\n        const url = page === 1 ? LIST_URL : `${LIST_URL}&pageIndex=${page}`;\r\n        const html = await fetchHtml(url);\r\n        const $ = cheerio.load(html);\r\n\r\n        // a[href=\"#view\"] 기반으로 공고 항목 탐색 (ul.board-list 클래스 없음)\r\n        $(\"a[href='#view']\").each((_, anchor) => {\r\n            const onclick = $(anchor).attr(\"onclick\") ?? \"\";\r\n            // onclick: doBbsFView('78336','29066','16010100','29066');return false;\r\n            const match = onclick.match(/doBbsFView\\(\\s*['\"]?\\d+['\"]?\\s*,\\s*['\"]?(\\d+)['\"]?/);\r\n            if (!match) return;\r\n            const bcIdx = match[1];\r\n\r\n            // 제목: span 목록에서 아이콘/뱃지 제외하고 텍스트 합치기\r\n            const spans = $(anchor).find(\"span\").toArray();\r\n            const spanTexts = spans\r\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                .map((s: any) => $(s).clone().children().remove().end().text().trim())\r\n                .filter((t: string) => t.length > 1 && !/^(첨부|new|N)$/i.test(t));\r\n\r\n            // span에서 추출 실패하면 anchor 전체 텍스트(정제) 사용\r\n            const title = spanTexts.length > 0\r\n                ? spanTexts.join(\" \").replace(/\\s+/g, \" \").trim()\r\n                : $(anchor).clone().find(\"em\").remove().end().text().replace(/\\s+/g, \" \").trim();\r\n\r\n            if (!title || title.length < 2) return;\r\n\r\n            // 날짜: 같은 a 태그 내 em 또는 span > em에서 날짜 패턴\r\n            const dateRaw = $(anchor).find(\"em\").toArray()\r\n                .map((e) => $(e).text().trim())\r\n                .find((t) => /\\d{4}[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/.test(t)) ?? \"\";\r\n            const date = normalizeDate(dateRaw);\r\n\r\n            items.push({ bcIdx, title, date });\r\n        });\r\n\r\n        if (items.length === 0 && page === 1) break;\r\n    }\r\n\r\n    return items;\r\n}\r\n\r\n// ── 상세 페이지에서 내용 추출 ─────────────────────────────────────────────────\r\nexport async function fetchNiaDetail(bcIdx: string): Promise<{ content: string; date: string }> {\r\n    const url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${bcIdx}`;\r\n    const html = await fetchHtml(url);\r\n    const $ = cheerio.load(html);\r\n\r\n    // 날짜: .src em 또는 .type01_info em\r\n    const dateRaw =\r\n        $(\".detail_type01 .src em, .type01_info .src em, .src em\").first().text().trim() ||\r\n        $(\".date, .reg_date\").first().text().trim();\r\n    const date = normalizeDate(dateRaw);\r\n\r\n    // 본문: .con_area 내부 텍스트 (HTML태그 제거, 정제)\r\n    const conArea = $(\".detail_type01 .con_area, .con_area\").first();\r\n    const content = conArea.text()\r\n        .replace(/\\s{3,}/g, \"\\n\\n\")  // 연속 공백/줄바꿈 정리\r\n        .trim();\r\n\r\n    return { content, date };\r\n}\r\n\r\n// ── 전체 수집 파이프라인 ──────────────────────────────────────────────────────\r\nexport async function scrapeNiaAnnouncements(\r\n    maxPages: number = 1,\r\n    fetchDetail: boolean = true\r\n): Promise<NiaAnnouncement[]> {\r\n    const listItems = await fetchNiaList(maxPages);\r\n    const results: NiaAnnouncement[] = [];\r\n\r\n    for (const item of listItems) {\r\n        const source_url = `${DETAIL_URL}?cbIdx=78336&bcIdx=${item.bcIdx}`;\r\n\r\n        let content = \"\";\r\n        let date = item.date;\r\n\r\n        if (fetchDetail) {\r\n            try {\r\n                const detail = await fetchNiaDetail(item.bcIdx);\r\n                content = detail.content;\r\n                // 상세 페이지 날짜가 더 정확한 경우 사용\r\n                if (detail.date) date = detail.date;\r\n            } catch (e) {\r\n                console.warn(`[NiaScraper] Detail fetch failed for bcIdx=${item.bcIdx}:`, e);\r\n            }\r\n        }\r\n\r\n        results.push({\r\n            bcIdx: item.bcIdx,\r\n            title: item.title,\r\n            date,\r\n            content,\r\n            source_url,\r\n        });\r\n    }\r\n\r\n    return results;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 309, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/nipa-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\n\r\nconst BASE_URL = \"https://www.nipa.kr\";\r\nconst LIST_URL = `${BASE_URL}/home/2-3/`;\r\n\r\nconst USER_AGENT =\r\n    \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\nexport type NipaAnnouncement = {\r\n    articleId: string;\r\n    title: string;\r\n    date: string;       // YYYY-MM-DD\r\n    content: string;\r\n    source_url: string;\r\n};\r\n\r\n// ── fetch helper ──────────────────────────────────────────────────────────────\r\nasync function fetchHtml(url: string): Promise<string> {\r\n    const res = await fetch(url, {\r\n        headers: {\r\n            \"User-Agent\": USER_AGENT,\r\n            \"Referer\": BASE_URL,\r\n        },\r\n        signal: AbortSignal.timeout(20_000),\r\n    });\r\n    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);\r\n    return res.text();\r\n}\r\n\r\n// ── 날짜 정규화 ───────────────────────────────────────────────────────────────\r\nfunction normalizeDate(raw: string): string {\r\n    const m = raw.trim().match(/(\\d{4})[.\\-/](\\d{1,2})[.\\-/](\\d{1,2})/);\r\n    if (!m) return raw.trim();\r\n    return `${m[1]}-${m[2].padStart(2, \"0\")}-${m[3].padStart(2, \"0\")}`;\r\n}\r\n\r\n// ── 목록 페이지에서 articleId 추출 ───────────────────────────────────────────\r\nexport async function fetchNipaList(\r\n    maxPages: number = 1\r\n): Promise<Array<{ articleId: string; title: string; date: string }>> {\r\n    const items: Array<{ articleId: string; title: string; date: string }> = [];\r\n\r\n    for (let page = 1; page <= maxPages; page++) {\r\n        const url = page === 1 ? LIST_URL : `${LIST_URL}?page=${page}`;\r\n        const html = await fetchHtml(url);\r\n        const $ = cheerio.load(html);\r\n\r\n        // 선택자: table.tb03 tbody tr > td.al > a (제목 링크)\r\n        // 대안: td a[href*=\"/home/2-3/\"]\r\n        const linkEls = $(\"table td a[href*='/home/2-3/'], table.tb03 td.al a\").toArray();\r\n\r\n        if (linkEls.length === 0) {\r\n            // 폴백: 모든 a[href] 에서 /home/2-3/{숫자} 패턴 탐색\r\n            $(\"a[href]\").each((_, el) => {\r\n                const href = $(el).attr(\"href\") ?? \"\";\r\n                const match = href.match(/\\/home\\/2-3\\/(\\d+)/);\r\n                if (!match) return;\r\n                const articleId = match[1];\r\n                const title = $(el).text().trim();\r\n                if (!title || title.length < 2) return;\r\n\r\n                const rowText = $(el).closest(\"tr\").text();\r\n                const date = normalizeDate(\r\n                    rowText.match(/(\\d{4})[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/)?.[0] ?? \"\"\r\n                );\r\n                if (!items.find((i) => i.articleId === articleId)) {\r\n                    items.push({ articleId, title, date });\r\n                }\r\n            });\r\n        } else {\r\n            for (const el of linkEls) {\r\n                const href = $(el).attr(\"href\") ?? \"\";\r\n                const match = href.match(/\\/home\\/2-3\\/(\\d+)/);\r\n                if (!match) continue;\r\n                const articleId = match[1];\r\n\r\n                const title = $(el).text().replace(/\\s+/g, \" \").trim();\r\n                if (!title || title.length < 2) continue;\r\n\r\n                // 날짜: 같은 tr의 텍스트에서 추출\r\n                const rowText = $(el).closest(\"tr\").text();\r\n                const date = normalizeDate(\r\n                    rowText.match(/(\\d{4})[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/)?.[0] ?? \"\"\r\n                );\r\n                if (!items.find((i) => i.articleId === articleId)) {\r\n                    items.push({ articleId, title, date });\r\n                }\r\n            }\r\n        }\r\n\r\n        if (linkEls.length === 0) break;\r\n    }\r\n\r\n    return items;\r\n}\r\n\r\n// ── 상세 페이지에서 내용 추출 ─────────────────────────────────────────────────\r\nexport async function fetchNipaDetail(\r\n    articleId: string\r\n): Promise<{ content: string; date: string; title: string }> {\r\n    const url = `${BASE_URL}/home/2-3/${articleId}`;\r\n    const html = await fetchHtml(url);\r\n    const $ = cheerio.load(html);\r\n\r\n    // 제목: table.tb05 thead tr th, .view-title, h3 등\r\n    const title =\r\n        $(\"table.tb05 thead tr th, .view-title, .tit_view, h3.tit\").first().text().trim() ||\r\n        $(\"h2, h3\").first().text().trim();\r\n\r\n    // 날짜: span.infoDt, .reg-date, .date 등\r\n    const dateRaw =\r\n        $(\"span.infoDt, .reg-date, [class*='date']\").toArray()\r\n            .map((e) => $(e).text().trim())\r\n            .find((t) => /\\d{4}[.\\-/]\\d{1,2}[.\\-/]\\d{1,2}/.test(t)) ?? \"\";\r\n    const date = normalizeDate(dateRaw);\r\n\r\n    // 본문: div.tbCont, .view-content, .board-content\r\n    const content =\r\n        $(\"div.tbCont, .view-content, .board-content, .con_area\").first()\r\n            .text()\r\n            .replace(/\\s{3,}/g, \"\\n\\n\")\r\n            .trim();\r\n\r\n    return { title, date, content };\r\n}\r\n\r\n// ── 전체 수집 파이프라인 ──────────────────────────────────────────────────────\r\nexport async function scrapeNipaAnnouncements(\r\n    maxPages: number = 1,\r\n    fetchDetail: boolean = true\r\n): Promise<NipaAnnouncement[]> {\r\n    const listItems = await fetchNipaList(maxPages);\r\n    const results: NipaAnnouncement[] = [];\r\n\r\n    for (const item of listItems) {\r\n        const source_url = `${BASE_URL}/home/2-3/${item.articleId}`;\r\n        let content = \"\";\r\n        let date = item.date;\r\n        let title = item.title;\r\n\r\n        if (fetchDetail) {\r\n            try {\r\n                const detail = await fetchNipaDetail(item.articleId);\r\n                content = detail.content;\r\n                if (detail.date) date = detail.date;\r\n                if (detail.title && detail.title.length > title.length) title = detail.title;\r\n            } catch (e) {\r\n                console.warn(`[NipaScraper] Detail fetch failed for articleId=${item.articleId}:`, e);\r\n            }\r\n        }\r\n\r\n        results.push({ articleId: item.articleId, title, date, content, source_url });\r\n    }\r\n\r\n    return results;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 526, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/email.ts"],"sourcesContent":["import nodemailer from \"nodemailer\";\r\n\r\n\r\n// ── SMTP 트랜스포터 (hanbiro, SSL 465) ───────────────────────────────────────\r\nfunction createTransporter() {\r\n  const password = process.env.SMTP_PASSWORD;\r\n  const from = process.env.SMTP_FROM;\r\n  if (!password) throw new Error(\"SMTP_PASSWORD 환경변수가 설정되지 않았습니다.\");\r\n  if (!from) throw new Error(\"SMTP_FROM 환경변수가 설정되지 않았습니다.\");\r\n\r\n  return nodemailer.createTransport({\r\n    host: \"mtsco.hanbiro.net\",\r\n    port: 465,\r\n    secure: true,        // SSL\r\n    auth: {\r\n      user: from,\r\n      pass: password,\r\n    },\r\n  });\r\n}\r\n\r\n// ── 신규 공고 이메일 알림 ─────────────────────────────────────────────────────\r\nexport type NewAnnouncementItem = {\r\n  title: string;\r\n  org_name: string | null;\r\n  announce_date: string | null;\r\n  category: string | null;\r\n  source_url: string | null;\r\n};\r\n\r\nexport async function sendNewAnnouncementsEmail(\r\n  items: NewAnnouncementItem[]\r\n): Promise<void> {\r\n  if (items.length === 0) return;\r\n\r\n  const from = process.env.SMTP_FROM;\r\n  const to = process.env.SMTP_TO;\r\n  if (!from || !to) throw new Error(\"SMTP_FROM 또는 SMTP_TO 환경변수가 설정되지 않았습니다.\");\r\n\r\n  const transporter = createTransporter();\r\n\r\n  // ── 카테고리 뱃지 ─────────────────────────────────────────────────────────────\r\n  const categoryBadge = (cat: string | null) => {\r\n    const map: Record<string, { bg: string; color: string }> = {\r\n      \"입찰공고\": { bg: \"#1c3d9c\", color: \"#ffffff\" },\r\n      \"공모\": { bg: \"#166534\", color: \"#ffffff\" },\r\n      \"지원사업\": { bg: \"#92400e\", color: \"#ffffff\" },\r\n      \"조달\": { bg: \"#6b21a8\", color: \"#ffffff\" },\r\n    };\r\n    const c = cat ?? \"-\";\r\n    const s = map[c] ?? { bg: \"#475569\", color: \"#ffffff\" };\r\n    return `<span style=\"display:inline-block;padding:3px 10px;border-radius:4px;font-size:11px;font-weight:700;background-color:${s.bg};color:${s.color};white-space:nowrap;\">${c}</span>`;\r\n  };\r\n\r\n  // ── 행 생성 ─────────────────────────────────────────────────────────────────\r\n  const rows = items.map((item, i) => {\r\n    const dateStr = item.announce_date ?? \"-\";\r\n    const titleHtml = item.source_url\r\n      ? `<a href=\"${item.source_url}\" style=\"color:#0a1e6e;text-decoration:none;font-weight:900;font-size:14px;line-height:1.6;letter-spacing:-0.01em;\">${item.title} <span style=\"font-size:12px;\">↗</span></a>`\r\n      : `<span style=\"color:#0a1e6e;font-weight:900;font-size:14px;line-height:1.6;\">${item.title}</span>`;\r\n    const rowBg = i % 2 === 0 ? \"#ffffff\" : \"#f9fafb\";\r\n\r\n    return `<tr style=\"background-color:${rowBg};\">\r\n      <td style=\"padding:14px 0;border-bottom:1px solid #edf0f7;text-align:center;vertical-align:middle;width:40px;color:#3a4a6b;font-size:12px;font-weight:700;\">${i + 1}</td>\r\n      <td style=\"padding:14px 8px;border-bottom:1px solid #edf0f7;\">${titleHtml}</td>\r\n      <td style=\"padding:14px 10px;border-bottom:1px solid #edf0f7;font-size:12px;color:#1e293b;white-space:nowrap;vertical-align:middle;font-weight:600;\">${item.org_name ?? \"미상\"}</td>\r\n      <td style=\"padding:14px 10px;border-bottom:1px solid #edf0f7;vertical-align:middle;\">${categoryBadge(item.category)}</td>\r\n      <td style=\"padding:14px 16px 14px 8px;border-bottom:1px solid #edf0f7;white-space:nowrap;vertical-align:middle;font-size:12px;color:#1e293b;font-weight:600;\">${dateStr}</td>\r\n    </tr>`;\r\n  }).join(\"\");\r\n\r\n  // ── 날짜 ────────────────────────────────────────────────────────────────────\r\n  const dateLabel = new Date().toLocaleDateString(\"ko-KR\", {\r\n    year: \"numeric\", month: \"long\", day: \"numeric\", weekday: \"long\",\r\n  });\r\n  const shortDate = new Date().toLocaleDateString(\"ko-KR\", { month: \"long\", day: \"numeric\" });\r\n\r\n  const html = `<!DOCTYPE html>\r\n<html lang=\"ko\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\r\n  <title>신규 사업공고 알림</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#eef1f7;font-family:'Apple SD Gothic Neo','Malgun Gothic',Arial,sans-serif;\">\r\n<table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#eef1f7;\">\r\n<tr><td align=\"center\" style=\"padding:24px 16px 40px;\">\r\n<table width=\"620\" cellpadding=\"0\" cellspacing=\"0\" style=\"max-width:620px;width:100%;\">\r\n\r\n  <!-- ══ 상단 브랜드바 ══ -->\r\n  <tr><td style=\"padding:0 0 12px;\">\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\"><tr>\r\n      <td>\r\n        <table cellpadding=\"0\" cellspacing=\"0\"><tr>\r\n          <td style=\"font-size:13px;font-weight:700;color:#1c3d9c;letter-spacing:-0.01em;\">에이마비서</td>\r\n          <td style=\"padding:0 10px;\"><span style=\"display:inline-block;width:1px;height:14px;background-color:#c0c8d8;vertical-align:middle;\"></span></td>\r\n          <td style=\"font-size:10px;color:#8a96aa;font-weight:500;letter-spacing:0.1em;text-transform:uppercase;\">Business Announcement Alert</td>\r\n        </tr></table>\r\n      </td>\r\n    </tr></table>\r\n  </td></tr>\r\n\r\n  <!-- ══ 메인 카드 ══ -->\r\n  <tr><td style=\"border-radius:8px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.10);\">\r\n\r\n    <!-- ① 헤더 (파란 배경) -->\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#1c3d9c;\">\r\n      <tr>\r\n        <td style=\"padding:22px 28px 0 28px;\">\r\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\"><tr>\r\n            <td style=\"vertical-align:top;\">\r\n              <p style=\"margin:0 0 6px;font-size:10px;font-weight:700;color:#a0b4e8;letter-spacing:0.1em;text-transform:uppercase;\">&#128203; NEW BUSINESS ANNOUNCEMENTS</p>\r\n              <h1 style=\"margin:0;font-size:22px;font-weight:900;color:#ffffff;line-height:1.25;letter-spacing:-0.02em;\">신규 사업공고<br>알림 리포트</h1>\r\n              <p style=\"margin:8px 0 0;font-size:12px;color:#a0b4e8;\">${dateLabel}</p>\r\n            </td>\r\n            <td style=\"vertical-align:top;text-align:right;padding-left:20px;\">\r\n              <table cellpadding=\"0\" cellspacing=\"0\" style=\"margin-left:auto;background-color:#162e7a;border-radius:6px;overflow:hidden;min-width:100px;\">\r\n                <tr><td style=\"padding:10px 16px;text-align:center;\">\r\n                  <div style=\"font-size:38px;font-weight:900;color:#f5a623;line-height:1;letter-spacing:-2px;\">${items.length}</div>\r\n                  <div style=\"font-size:10px;color:#a0b4e8;margin-top:4px;\">건의 신규 공고</div>\r\n                  <div style=\"font-size:10px;color:#6a80b0;margin-top:1px;\">${shortDate} 기준</div>\r\n                </td></tr>\r\n              </table>\r\n            </td>\r\n          </tr></table>\r\n        </td>\r\n      </tr>\r\n      <!-- 클릭 안내 버튼 -->\r\n      <tr>\r\n        <td style=\"padding:14px 28px 20px;\">\r\n          <table cellpadding=\"0\" cellspacing=\"0\">\r\n            <tr><td style=\"background-color:#f5a623;border-radius:6px;padding:9px 24px;text-align:center;\">\r\n              <span style=\"font-size:12px;font-weight:700;color:#1c3d9c;\">&#128276;&nbsp; 공고명 클릭 시 원문으로 바로 이동합니다</span>\r\n            </td></tr>\r\n          </table>\r\n        </td>\r\n      </tr>\r\n    </table>\r\n\r\n    <!-- ③ 테이블 헤더 -->\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f0f2f7;border-top:1px solid #dde2ef;\">\r\n      <tr>\r\n        <th style=\"width:40px;padding:10px 0;font-size:11px;font-weight:700;color:#6b7897;text-align:center;\">#</th>\r\n        <th style=\"padding:10px 8px;font-size:11px;font-weight:700;color:#3a4a6b;text-align:left;letter-spacing:0.05em;\">공&nbsp;&nbsp;고&nbsp;&nbsp;명</th>\r\n        <th style=\"padding:10px 10px;font-size:11px;font-weight:700;color:#3a4a6b;text-align:left;white-space:nowrap;\">기 관</th>\r\n        <th style=\"padding:10px 10px;font-size:11px;font-weight:700;color:#3a4a6b;text-align:center;white-space:nowrap;\">구 분</th>\r\n        <th style=\"padding:10px 16px 10px 8px;font-size:11px;font-weight:700;color:#3a4a6b;text-align:right;white-space:nowrap;\">날 짜</th>\r\n      </tr>\r\n    </table>\r\n\r\n    <!-- ④ 공고 행 -->\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#ffffff;\">\r\n      ${rows}\r\n    </table>\r\n\r\n    <!-- ⑥ 푸터 -->\r\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"background-color:#f7f9fc;border-top:1px solid #e2e8f0;\">\r\n      <tr>\r\n        <td style=\"padding:18px 24px;\">\r\n          <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\">\r\n            <tr>\r\n              <td>\r\n                <p style=\"margin:0;font-size:12px;color:#6b7897;line-height:1.8;\">\r\n                  본 메일은 <strong style=\"color:#1c3d9c;\">에이마비서</strong>의 사업공고 자동 수집 시스템이 발송했습니다.<br>\r\n                  수신 거부 · 문의: 관리자에게 연락하세요.\r\n                </p>\r\n              </td>\r\n              <td style=\"text-align:right;vertical-align:middle;padding-left:16px;\">\r\n                <div style=\"display:inline-block;background-color:#1c3d9c;border-radius:6px;padding:8px 16px;text-align:center;\">\r\n                  <div style=\"font-size:12px;font-weight:700;color:#ffffff;\">에이마비서</div>\r\n                </div>\r\n              </td>\r\n            </tr>\r\n          </table>\r\n        </td>\r\n      </tr>\r\n    </table>\r\n\r\n  </td></tr><!-- /메인 카드 -->\r\n\r\n</table>\r\n</td></tr>\r\n</table>\r\n</body>\r\n</html>`;\r\n\r\n  await transporter.sendMail({\r\n    from: `\"에이마비서 알림\" <${from}>`,\r\n    to: to,\r\n    subject: `[사업공고] 신규 ${items.length}건 - ${new Date().toLocaleDateString(\"ko-KR\")}`,\r\n    html,\r\n  });\r\n\r\n  console.log(`[Email] 신규 공고 ${items.length}건 이메일 발송 완료 → ${to}`);\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAGA,2EAA2E;AAC3E,SAAS;IACP,MAAM,WAAW,QAAQ,GAAG,CAAC,aAAa;IAC1C,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,IAAI,CAAC,UAAU,MAAM,IAAI,MAAM;IAC/B,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAE3B,OAAO,4JAAU,CAAC,eAAe,CAAC;QAChC,MAAM;QACN,MAAM;QACN,QAAQ;QACR,MAAM;YACJ,MAAM;YACN,MAAM;QACR;IACF;AACF;AAWO,eAAe,0BACpB,KAA4B;IAE5B,IAAI,MAAM,MAAM,KAAK,GAAG;IAExB,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,MAAM,KAAK,QAAQ,GAAG,CAAC,OAAO;IAC9B,IAAI,CAAC,QAAQ,CAAC,IAAI,MAAM,IAAI,MAAM;IAElC,MAAM,cAAc;IAEpB,2EAA2E;IAC3E,MAAM,gBAAgB,CAAC;QACrB,MAAM,MAAqD;YACzD,QAAQ;gBAAE,IAAI;gBAAW,OAAO;YAAU;YAC1C,MAAM;gBAAE,IAAI;gBAAW,OAAO;YAAU;YACxC,QAAQ;gBAAE,IAAI;gBAAW,OAAO;YAAU;YAC1C,MAAM;gBAAE,IAAI;gBAAW,OAAO;YAAU;QAC1C;QACA,MAAM,IAAI,OAAO;QACjB,MAAM,IAAI,GAAG,CAAC,EAAE,IAAI;YAAE,IAAI;YAAW,OAAO;QAAU;QACtD,OAAO,CAAC,qHAAqH,EAAE,EAAE,EAAE,CAAC,OAAO,EAAE,EAAE,KAAK,CAAC,sBAAsB,EAAE,EAAE,OAAO,CAAC;IACzL;IAEA,4EAA4E;IAC5E,MAAM,OAAO,MAAM,GAAG,CAAC,CAAC,MAAM;QAC5B,MAAM,UAAU,KAAK,aAAa,IAAI;QACtC,MAAM,YAAY,KAAK,UAAU,GAC7B,CAAC,SAAS,EAAE,KAAK,UAAU,CAAC,oHAAoH,EAAE,KAAK,KAAK,CAAC,2CAA2C,CAAC,GACzM,CAAC,4EAA4E,EAAE,KAAK,KAAK,CAAC,OAAO,CAAC;QACtG,MAAM,QAAQ,IAAI,MAAM,IAAI,YAAY;QAExC,OAAO,CAAC,4BAA4B,EAAE,MAAM;kKACkH,EAAE,IAAI,EAAE;oEACtG,EAAE,UAAU;2JAC2E,EAAE,KAAK,QAAQ,IAAI,KAAK;2FACxF,EAAE,cAAc,KAAK,QAAQ,EAAE;oKAC0C,EAAE,QAAQ;SACrK,CAAC;IACR,GAAG,IAAI,CAAC;IAER,6EAA6E;IAC7E,MAAM,YAAY,IAAI,OAAO,kBAAkB,CAAC,SAAS;QACvD,MAAM;QAAW,OAAO;QAAQ,KAAK;QAAW,SAAS;IAC3D;IACA,MAAM,YAAY,IAAI,OAAO,kBAAkB,CAAC,SAAS;QAAE,OAAO;QAAQ,KAAK;IAAU;IAEzF,MAAM,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;sEAoCsD,EAAE,UAAU;;;;;+GAK6B,EAAE,MAAM,MAAM,CAAC;;4EAElD,EAAE,UAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAgClF,EAAE,KAAK;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;OAgCN,CAAC;IAEN,MAAM,YAAY,QAAQ,CAAC;QACzB,MAAM,CAAC,YAAY,EAAE,KAAK,CAAC,CAAC;QAC5B,IAAI;QACJ,SAAS,CAAC,UAAU,EAAE,MAAM,MAAM,CAAC,IAAI,EAAE,IAAI,OAAO,kBAAkB,CAAC,UAAU;QACjF;IACF;IAEA,QAAQ,GAAG,CAAC,CAAC,cAAc,EAAE,MAAM,MAAM,CAAC,cAAc,EAAE,IAAI;AAChE"}},
    {"offset": {"line": 725, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/lib/services/rfp-scraper.ts"],"sourcesContent":["import * as cheerio from \"cheerio\";\r\nimport { createClient, SupabaseClient } from \"@supabase/supabase-js\";\r\nimport { scrapeNiaAnnouncements } from \"./nia-scraper\";\r\nimport { scrapeNipaAnnouncements } from \"./nipa-scraper\";\r\nimport { sendNewAnnouncementsEmail, NewAnnouncementItem } from \"./email\";\r\n\r\n// ── Supabase Admin Client (service_role 우선, 없으면 anon key 폴백) ──────────\r\nfunction getAdminClient() {\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n    // rfp_announcements는 RLS disabled이므로 anon key로도 INSERT 가능\r\n    const key =\r\n        process.env.SUPABASE_SERVICE_ROLE_KEY &&\r\n            process.env.SUPABASE_SERVICE_ROLE_KEY !== \"your-service-role-key-here\"\r\n            ? process.env.SUPABASE_SERVICE_ROLE_KEY\r\n            : process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n    return createClient(url, key, { auth: { persistSession: false } });\r\n}\r\n\r\n// ── 타입 ─────────────────────────────────────────────────────────────────────\r\nexport type CollMeth = \"API\" | \"RSS\" | \"Static Scraper\" | \"Dynamic Scraper\";\r\n\r\nexport type PublicOrg = {\r\n    id: number;\r\n    org_name: string;\r\n    org_type: string | null;\r\n    homepage_url: string | null;\r\n    rfp_url: string | null;\r\n    coll_meth: CollMeth | null;\r\n    is_active: boolean;\r\n};\r\n\r\nexport type ScrapedAnnouncement = {\r\n    title: string;\r\n    category?: string;\r\n    announce_date?: string | null;   // ISO date string\r\n    description?: string | null;\r\n    source_url?: string | null;\r\n};\r\n\r\nexport type ScrapeOrgResult = {\r\n    org_id: number;\r\n    org_name: string;\r\n    status: \"success\" | \"skipped\" | \"error\";\r\n    inserted: number;\r\n    skipped: number;\r\n    error?: string;\r\n    newItems?: NewAnnouncementItem[];  // 신규 공고 목록 (이메일용)\r\n};\r\n\r\n// ── unique_key 생성 (단방향 해시 없이 결정적 문자열로 처리) ─────────────────\r\nfunction buildUniqueKey(orgId: number, title: string, announce_date: string | null | undefined): string {\r\n    const d = announce_date ?? \"no-deadline\";\r\n    // Node.js crypto 없이 간단한 결정적 키 생성 (서버리스 환경 호환)\r\n    return `${orgId}::${title.trim().toLowerCase()}::${d}`;\r\n}\r\n\r\n// ── 정적 스크래퍼 (Cheerio) ──────────────────────────────────────────────────\r\nexport class StaticScraper {\r\n    private readonly userAgent =\r\n        \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\";\r\n\r\n    async scrape(rfpUrl: string): Promise<ScrapedAnnouncement[]> {\r\n        const html = await this.fetchHtml(rfpUrl);\r\n        const $ = cheerio.load(html);\r\n        const results: ScrapedAnnouncement[] = [];\r\n\r\n        // ── 전략 1: table 기반 목록 ─────────────────────────────────────────\r\n        const tableRows = $(\"table tbody tr, table tr\").toArray();\r\n        if (tableRows.length > 0) {\r\n            for (const row of tableRows) {\r\n                const cells = $(row).find(\"td\");\r\n                if (cells.length < 2) continue;\r\n\r\n                const titleEl = $(row).find(\"td a\").first();\r\n                const title = titleEl.text().trim() || $(cells.get(0)).text().trim();\r\n                if (!title || title.length < 2) continue;\r\n\r\n                const href = titleEl.attr(\"href\");\r\n                const source_url = href\r\n                    ? href.startsWith(\"http\") ? href : new URL(href, rfpUrl).href\r\n                    : null;\r\n\r\n                // 날짜 패턴 찾기 (YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD)\r\n                const rowText = $(row).text();\r\n                const announce_date = this.extractDate(rowText);\r\n\r\n                results.push({ title, source_url, announce_date, description: null });\r\n            }\r\n        }\r\n\r\n        // ── 전략 2: list item 기반 ──────────────────────────────────────────\r\n        if (results.length === 0) {\r\n            const listItems = $(\r\n                \"ul li a, .list-item a, .bbs-list a, .board-list a, .notice-list a, article a\"\r\n            ).toArray();\r\n\r\n            for (const el of listItems) {\r\n                const title = $(el).text().trim();\r\n                if (!title || title.length < 3) continue;\r\n\r\n                const href = $(el).attr(\"href\");\r\n                const source_url = href\r\n                    ? href.startsWith(\"http\") ? href : new URL(href, rfpUrl).href\r\n                    : null;\r\n\r\n                const parentText = $(el).parent().text();\r\n                const announce_date = this.extractDate(parentText);\r\n\r\n                results.push({ title, source_url, announce_date, description: null });\r\n            }\r\n        }\r\n\r\n        // ── 전략 3: RSS/Atom feed XML ────────────────────────────────────────\r\n        if (results.length === 0 && (rfpUrl.includes(\"rss\") || rfpUrl.includes(\"feed\") || rfpUrl.includes(\"atom\"))) {\r\n            $(\"item, entry\").each((_, el) => {\r\n                const title = $(el).find(\"title\").text().trim();\r\n                if (!title) return;\r\n\r\n                const source_url = $(el).find(\"link\").text().trim() ||\r\n                    $(el).find(\"link\").attr(\"href\") || null;\r\n                const pubDate = $(el).find(\"pubDate, published, updated\").text().trim();\r\n                const description = $(el).find(\"description, summary, content\").text().trim() || null;\r\n                const announce_date = this.extractDate(pubDate || \"\");\r\n\r\n                results.push({ title, source_url, announce_date, description });\r\n            });\r\n        }\r\n\r\n        return results.slice(0, 100); // 최대 100개 제한\r\n    }\r\n\r\n    private async fetchHtml(url: string): Promise<string> {\r\n        const res = await fetch(url, {\r\n            headers: { \"User-Agent\": this.userAgent },\r\n            signal: AbortSignal.timeout(20_000), // 20초 타임아웃\r\n        });\r\n        if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);\r\n        return res.text();\r\n    }\r\n\r\n    /** 텍스트에서 YYYY-MM-DD / YYYY.MM.DD / YYYY/MM/DD 패턴 추출 */\r\n    private extractDate(text: string): string | null {\r\n        const match = text.match(/(\\d{4})[-./](\\d{1,2})[-./](\\d{1,2})/);\r\n        if (!match) return null;\r\n        const [, y, m, d] = match;\r\n        return `${y}-${m.padStart(2, \"0\")}-${d.padStart(2, \"0\")}`;\r\n    }\r\n}\r\n\r\n// ── 동적 스크래퍼 Stub ───────────────────────────────────────────────────────\r\nexport class DynamicScraperStub {\r\n    async scrape(rfpUrl: string, orgName: string): Promise<ScrapedAnnouncement[]> {\r\n        console.warn(\r\n            `[RfpScraper] Dynamic Scraper not available in serverless env. ` +\r\n            `Skipping ${orgName} (${rfpUrl}). ` +\r\n            `To enable: integrate BrowserBase or ScrapingBee API.`\r\n        );\r\n        return [];\r\n    }\r\n}\r\n\r\n// ── 메인 오케스트레이터 ──────────────────────────────────────────────────────\r\nexport class RfpScraper {\r\n    private staticScraper = new StaticScraper();\r\n    private dynamicScraper = new DynamicScraperStub();\r\n\r\n    /** NIA(한국지능정보사회진흥원) URL 패턴 감지 */\r\n    private isNiaUrl(url: string): boolean {\r\n        return url.includes(\"nia.or.kr\") && url.includes(\"cbIdx=78336\");\r\n    }\r\n\r\n    /** NIPA(정보통신산업진흥원) URL 패턴 감지 */\r\n    private isNipaUrl(url: string): boolean {\r\n        return url.includes(\"nipa.kr\");\r\n    }\r\n\r\n    async run(): Promise<ScrapeOrgResult[]> {\r\n        const supabase = getAdminClient();\r\n        const results: ScrapeOrgResult[] = [];\r\n\r\n        // 1. 활성 필터링 키워드 목록 조회\r\n        const { data: keywordRows } = await supabase\r\n            .from(\"rfp_filter_keywords\")\r\n            .select(\"keyword\")\r\n            .eq(\"is_active\", true);\r\n\r\n        const filterKeywords: string[] = (keywordRows ?? []).map((r: any) =>\r\n            (r.keyword as string).toLowerCase()\r\n        );\r\n\r\n        if (filterKeywords.length > 0) {\r\n            console.log(`[RfpScraper] 필터링 키워드 ${filterKeywords.length}개 적용: ${filterKeywords.join(\", \")}`);\r\n        } else {\r\n            console.log(\"[RfpScraper] 필터링 키워드 없음 — 전체 수집 모드\");\r\n        }\r\n\r\n        // 2. 수집 활성화된 기관 목록 조회\r\n        const { data: orgs, error: orgsErr } = await supabase\r\n            .from(\"rfp_public_org\")\r\n            .select(\"id, org_name, org_type, homepage_url, rfp_url, coll_meth, is_active\")\r\n            .eq(\"is_active\", true);\r\n\r\n        if (orgsErr) {\r\n            console.error(\"[RfpScraper] Failed to fetch orgs:\", orgsErr.message);\r\n            return [{ org_id: 0, org_name: \"N/A\", status: \"error\", inserted: 0, skipped: 0, error: orgsErr.message }];\r\n        }\r\n\r\n        if (!orgs || orgs.length === 0) {\r\n            console.log(\"[RfpScraper] No active orgs found.\");\r\n            return [];\r\n        }\r\n\r\n        console.log(`[RfpScraper] Processing ${orgs.length} active orgs`);\r\n\r\n        // 3. 기관별 수집\r\n        for (const org of orgs as PublicOrg[]) {\r\n            const result = await this.scrapeOrg(supabase, org, filterKeywords);\r\n            results.push(result);\r\n            console.log(\r\n                `[RfpScraper] ${org.org_name}: ${result.status} ` +\r\n                `(inserted=${result.inserted}, skipped=${result.skipped})`\r\n            );\r\n        }\r\n\r\n        // 4. 신규 공고가 있으면 이메일 발송\r\n        const allNewItems: NewAnnouncementItem[] = results.flatMap((r) => r.newItems ?? []);\r\n        if (allNewItems.length > 0) {\r\n            try {\r\n                await sendNewAnnouncementsEmail(allNewItems);\r\n            } catch (mailErr: any) {\r\n                console.error(\"[RfpScraper] 이메일 발송 실패:\", mailErr.message);\r\n            }\r\n        }\r\n\r\n        return results;\r\n    }\r\n\r\n    /** 제목 또는 설명에 활성 필터링 키워드가 하나라도 포함되는지 검사 */\r\n    private matchesKeywords(ann: ScrapedAnnouncement, keywords: string[]): boolean {\r\n        if (keywords.length === 0) return true; // 키워드 없으면 전체 통과\r\n        const haystack = [\r\n            ann.title ?? \"\",\r\n            ann.description ?? \"\",\r\n        ].join(\" \").toLowerCase();\r\n        return keywords.some((kw) => haystack.includes(kw));\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private async scrapeOrg(supabase: SupabaseClient<any, any, any>, org: PublicOrg, filterKeywords: string[] = []): Promise<ScrapeOrgResult> {\r\n        const base: ScrapeOrgResult = {\r\n            org_id: org.id,\r\n            org_name: org.org_name,\r\n            status: \"success\",\r\n            inserted: 0,\r\n            skipped: 0,\r\n        };\r\n\r\n        if (!org.rfp_url) {\r\n            return { ...base, status: \"skipped\", error: \"rfp_url 없음\" };\r\n        }\r\n\r\n        // 3. 엔진 분기: URL 패턴 우선 → coll_meth 순서로 결정\r\n        let announcements: ScrapedAnnouncement[] = [];\r\n        try {\r\n            if (org.coll_meth === \"Dynamic Scraper\") {\r\n                announcements = await this.dynamicScraper.scrape(org.rfp_url, org.org_name);\r\n            } else if (this.isNiaUrl(org.rfp_url)) {\r\n                // NIA(한국지능정보사회진흥원): 전용 스크래퍼 사용\r\n                const niaResults = await scrapeNiaAnnouncements(1, true);\r\n                announcements = niaResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"입찰공고\",\r\n                    announce_date: r.date || null,\r\n                    description: r.content?.slice(0, 2000) || null,\r\n                    source_url: r.source_url,\r\n                }));\r\n            } else if (this.isNipaUrl(org.rfp_url)) {\r\n                // NIPA(정보통신산업진흥원): 전용 스크래퍼 사용\r\n                const nipaResults = await scrapeNipaAnnouncements(1, true);\r\n                announcements = nipaResults.map((r) => ({\r\n                    title: r.title,\r\n                    category: \"공고\",\r\n                    announce_date: r.date || null,\r\n                    description: r.content?.slice(0, 2000) || null,\r\n                    source_url: r.source_url,\r\n                }));\r\n            } else {\r\n                // 범용 Cheerio 스크래퍼 (table/list/RSS 전략)\r\n                announcements = await this.staticScraper.scrape(org.rfp_url);\r\n            }\r\n        } catch (err: any) {\r\n            return { ...base, status: \"error\", error: err.message };\r\n        }\r\n\r\n        if (announcements.length === 0) {\r\n            return { ...base, status: \"skipped\", error: \"공고 없음 (파싱 결과 0건)\" };\r\n        }\r\n\r\n        // 4. 필터링 키워드 적용\r\n        const filtered = announcements.filter((ann) => this.matchesKeywords(ann, filterKeywords));\r\n        console.log(\r\n            `[RfpScraper] ${org.org_name}: 수집 ${announcements.length}건 → 키워드 필터 후 ${filtered.length}건`\r\n        );\r\n\r\n        if (filtered.length === 0) {\r\n            return { ...base, status: \"skipped\", error: \"키워드 매칭 결과 0건\" };\r\n        }\r\n\r\n        // 5. 증분 저장 (unique_key 기준 → 신규만 INSERT)\r\n        let inserted = 0;\r\n        let skipped = 0;\r\n        const newItems: NewAnnouncementItem[] = [];\r\n\r\n        for (const ann of filtered) {\r\n            if (!ann.title?.trim()) continue;\r\n\r\n            const unique_key = buildUniqueKey(org.id, ann.title, ann.announce_date);\r\n\r\n            const row = {\r\n                org_id: org.id,\r\n                unique_key,\r\n                title: ann.title.trim(),\r\n                category: ann.category ?? org.org_type ?? null,\r\n                announce_date: ann.announce_date ?? null,\r\n                description: ann.description ?? null,\r\n                source_url: ann.source_url ?? null,\r\n                is_active: true,\r\n                scraped_at: new Date().toISOString(),\r\n            };\r\n\r\n            // 증분 수집: unique_key 중복 여부 먼저 확인\r\n            const { data: existing } = await supabase\r\n                .from(\"rfp_announcements\")\r\n                .select(\"id\")\r\n                .eq(\"unique_key\", unique_key)\r\n                .maybeSingle();\r\n\r\n            if (existing) {\r\n                skipped++;\r\n                continue;\r\n            }\r\n\r\n            const { error: insertErr } = await supabase\r\n                .from(\"rfp_announcements\")\r\n                .insert(row);\r\n\r\n            if (insertErr) {\r\n                console.error(`[RfpScraper] Insert error for \"${ann.title}\":`, insertErr.message);\r\n            } else {\r\n                inserted++;\r\n                // 이메일 발송용 신규 공고 누적\r\n                newItems.push({\r\n                    title: ann.title.trim(),\r\n                    org_name: org.org_name,\r\n                    announce_date: ann.announce_date ?? null,\r\n                    category: ann.category ?? null,\r\n                    source_url: ann.source_url ?? null,\r\n                });\r\n            }\r\n        }\r\n\r\n        return { ...base, inserted, skipped, newItems };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1034, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/antigravity/SajangnimBiseo/src/app/api/cron/rfp-scrape/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { RfpScraper } from \"@/lib/services/rfp-scraper\";\r\n\r\nexport const dynamic = \"force-dynamic\";\r\nexport const maxDuration = 300; // Vercel Pro: 최대 5분 실행 허용\r\n\r\nexport async function GET(request: Request) {\r\n    // ── 보안: CRON_SECRET 검증 ─────────────────────────────────────────────\r\n    const authHeader = request.headers.get(\"authorization\");\r\n    const cronSecret = process.env.CRON_SECRET;\r\n\r\n    if (cronSecret && authHeader !== `Bearer ${cronSecret}`) {\r\n        console.warn(\"[rfp-scrape] Unauthorized cron request\");\r\n        return new NextResponse(\"Unauthorized\", { status: 401 });\r\n    }\r\n\r\n    const startedAt = new Date().toISOString();\r\n    console.log(`[rfp-scrape] Cron started at ${startedAt}`);\r\n\r\n    try {\r\n        const scraper = new RfpScraper();\r\n        const results = await scraper.run();\r\n\r\n        const totalInserted = results.reduce((s, r) => s + r.inserted, 0);\r\n        const totalSkipped = results.reduce((s, r) => s + r.skipped, 0);\r\n        const errors = results.filter((r) => r.status === \"error\");\r\n\r\n        console.log(\r\n            `[rfp-scrape] Done. inserted=${totalInserted}, skipped=${totalSkipped}, errors=${errors.length}`\r\n        );\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            startedAt,\r\n            completedAt: new Date().toISOString(),\r\n            summary: {\r\n                totalOrgs: results.length,\r\n                totalInserted,\r\n                totalSkipped,\r\n                totalErrors: errors.length,\r\n            },\r\n            results,\r\n        });\r\n    } catch (err: any) {\r\n        console.error(\"[rfp-scrape] Fatal error:\", err);\r\n        return NextResponse.json(\r\n            { success: false, error: err.message, startedAt },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEO,MAAM,UAAU;AAChB,MAAM,cAAc,KAAK,0BAA0B;AAEnD,eAAe,IAAI,OAAgB;IACtC,sEAAsE;IACtE,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,MAAM,aAAa,QAAQ,GAAG,CAAC,WAAW;IAE1C,IAAI,cAAc,eAAe,CAAC,OAAO,EAAE,YAAY,EAAE;QACrD,QAAQ,IAAI,CAAC;QACb,OAAO,IAAI,gJAAY,CAAC,gBAAgB;YAAE,QAAQ;QAAI;IAC1D;IAEA,MAAM,YAAY,IAAI,OAAO,WAAW;IACxC,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,WAAW;IAEvD,IAAI;QACA,MAAM,UAAU,IAAI,wJAAU;QAC9B,MAAM,UAAU,MAAM,QAAQ,GAAG;QAEjC,MAAM,gBAAgB,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,EAAE,QAAQ,EAAE;QAC/D,MAAM,eAAe,QAAQ,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,EAAE,OAAO,EAAE;QAC7D,MAAM,SAAS,QAAQ,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,KAAK;QAElD,QAAQ,GAAG,CACP,CAAC,4BAA4B,EAAE,cAAc,UAAU,EAAE,aAAa,SAAS,EAAE,OAAO,MAAM,EAAE;QAGpG,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT;YACA,aAAa,IAAI,OAAO,WAAW;YACnC,SAAS;gBACL,WAAW,QAAQ,MAAM;gBACzB;gBACA;gBACA,aAAa,OAAO,MAAM;YAC9B;YACA;QACJ;IACJ,EAAE,OAAO,KAAU;QACf,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,SAAS;YAAO,OAAO,IAAI,OAAO;YAAE;QAAU,GAChD;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}