module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/node:stream [external] (node:stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/string_decoder [external] (string_decoder, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/node:assert [external] (node:assert, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:assert", () => require("node:assert"));

module.exports = mod;
}),
"[externals]/node:net [external] (node:net, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:net", () => require("node:net"));

module.exports = mod;
}),
"[externals]/node:http [external] (node:http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:http", () => require("node:http"));

module.exports = mod;
}),
"[externals]/node:querystring [external] (node:querystring, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:querystring", () => require("node:querystring"));

module.exports = mod;
}),
"[externals]/node:events [external] (node:events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:events", () => require("node:events"));

module.exports = mod;
}),
"[externals]/node:diagnostics_channel [external] (node:diagnostics_channel, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:diagnostics_channel", () => require("node:diagnostics_channel"));

module.exports = mod;
}),
"[externals]/node:util [external] (node:util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:util", () => require("node:util"));

module.exports = mod;
}),
"[externals]/node:tls [external] (node:tls, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:tls", () => require("node:tls"));

module.exports = mod;
}),
"[externals]/node:buffer [external] (node:buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:buffer", () => require("node:buffer"));

module.exports = mod;
}),
"[externals]/node:zlib [external] (node:zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:zlib", () => require("node:zlib"));

module.exports = mod;
}),
"[externals]/node:perf_hooks [external] (node:perf_hooks, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:perf_hooks", () => require("node:perf_hooks"));

module.exports = mod;
}),
"[externals]/node:util/types [external] (node:util/types, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:util/types", () => require("node:util/types"));

module.exports = mod;
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[externals]/node:worker_threads [external] (node:worker_threads, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:worker_threads", () => require("node:worker_threads"));

module.exports = mod;
}),
"[externals]/node:http2 [external] (node:http2, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:http2", () => require("node:http2"));

module.exports = mod;
}),
"[externals]/node:async_hooks [external] (node:async_hooks, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:async_hooks", () => require("node:async_hooks"));

module.exports = mod;
}),
"[externals]/node:console [external] (node:console, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:console", () => require("node:console"));

module.exports = mod;
}),
"[externals]/node:fs/promises [external] (node:fs/promises, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:fs/promises", () => require("node:fs/promises"));

module.exports = mod;
}),
"[externals]/node:path [external] (node:path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:path", () => require("node:path"));

module.exports = mod;
}),
"[externals]/node:timers [external] (node:timers, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:timers", () => require("node:timers"));

module.exports = mod;
}),
"[externals]/node:dns [external] (node:dns, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:dns", () => require("node:dns"));

module.exports = mod;
}),
"[project]/src/lib/services/rfp-scraper.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "DynamicScraperStub",
    ()=>DynamicScraperStub,
    "RfpScraper",
    ()=>RfpScraper,
    "StaticScraper",
    ()=>StaticScraper
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$cheerio$2f$dist$2f$esm$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/cheerio/dist/esm/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$cheerio$2f$dist$2f$esm$2f$load$2d$parse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/cheerio/dist/esm/load-parse.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/index.mjs [app-route] (ecmascript) <locals>");
;
;
// ── Supabase Admin Client (service_role 우선, 없으면 anon key 폴백) ──────────
function getAdminClient() {
    const url = ("TURBOPACK compile-time value", "https://zrdcdkafvpbbcmyrzeku.supabase.co");
    // rfp_announcements는 RLS disabled이므로 anon key로도 INSERT 가능
    const key = process.env.SUPABASE_SERVICE_ROLE_KEY && process.env.SUPABASE_SERVICE_ROLE_KEY !== "your-service-role-key-here" ? process.env.SUPABASE_SERVICE_ROLE_KEY : ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyZGNka2FmdnBiYmNteXJ6ZWt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTAyODAsImV4cCI6MjA4NDEyNjI4MH0.CvbveMYPBr-U5ktBFm8jgAt0DE3l9Xv6OuSZeQ9r9pQ");
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(url, key, {
        auth: {
            persistSession: false
        }
    });
}
// ── unique_key 생성 (단방향 해시 없이 결정적 문자열로 처리) ─────────────────
function buildUniqueKey(orgId, title, deadline) {
    const d = deadline ?? "no-deadline";
    // Node.js crypto 없이 간단한 결정적 키 생성 (서버리스 환경 호환)
    return `${orgId}::${title.trim().toLowerCase()}::${d}`;
}
class StaticScraper {
    userAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
    async scrape(rfpUrl) {
        const html = await this.fetchHtml(rfpUrl);
        const $ = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$cheerio$2f$dist$2f$esm$2f$load$2d$parse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["load"](html);
        const results = [];
        // ── 전략 1: table 기반 목록 ─────────────────────────────────────────
        const tableRows = $("table tbody tr, table tr").toArray();
        if (tableRows.length > 0) {
            for (const row of tableRows){
                const cells = $(row).find("td");
                if (cells.length < 2) continue;
                const titleEl = $(row).find("td a").first();
                const title = titleEl.text().trim() || $(cells.get(0)).text().trim();
                if (!title || title.length < 2) continue;
                const href = titleEl.attr("href");
                const source_url = href ? href.startsWith("http") ? href : new URL(href, rfpUrl).href : null;
                // 날짜 패턴 찾기 (YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD)
                const rowText = $(row).text();
                const deadline = this.extractDate(rowText);
                results.push({
                    title,
                    source_url,
                    deadline,
                    description: null
                });
            }
        }
        // ── 전략 2: list item 기반 ──────────────────────────────────────────
        if (results.length === 0) {
            const listItems = $("ul li a, .list-item a, .bbs-list a, .board-list a, .notice-list a, article a").toArray();
            for (const el of listItems){
                const title = $(el).text().trim();
                if (!title || title.length < 3) continue;
                const href = $(el).attr("href");
                const source_url = href ? href.startsWith("http") ? href : new URL(href, rfpUrl).href : null;
                const parentText = $(el).parent().text();
                const deadline = this.extractDate(parentText);
                results.push({
                    title,
                    source_url,
                    deadline,
                    description: null
                });
            }
        }
        // ── 전략 3: RSS/Atom feed XML ────────────────────────────────────────
        if (results.length === 0 && (rfpUrl.includes("rss") || rfpUrl.includes("feed") || rfpUrl.includes("atom"))) {
            $("item, entry").each((_, el)=>{
                const title = $(el).find("title").text().trim();
                if (!title) return;
                const source_url = $(el).find("link").text().trim() || $(el).find("link").attr("href") || null;
                const pubDate = $(el).find("pubDate, published, updated").text().trim();
                const description = $(el).find("description, summary, content").text().trim() || null;
                const deadline = this.extractDate(pubDate || "");
                results.push({
                    title,
                    source_url,
                    deadline,
                    description
                });
            });
        }
        return results.slice(0, 100); // 최대 100개 제한
    }
    async fetchHtml(url) {
        const res = await fetch(url, {
            headers: {
                "User-Agent": this.userAgent
            },
            signal: AbortSignal.timeout(20_000)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
        return res.text();
    }
    /** 텍스트에서 YYYY-MM-DD / YYYY.MM.DD / YYYY/MM/DD 패턴 추출 */ extractDate(text) {
        const match = text.match(/(\d{4})[-./](\d{1,2})[-./](\d{1,2})/);
        if (!match) return null;
        const [, y, m, d] = match;
        return `${y}-${m.padStart(2, "0")}-${d.padStart(2, "0")}`;
    }
}
class DynamicScraperStub {
    async scrape(rfpUrl, orgName) {
        console.warn(`[RfpScraper] Dynamic Scraper not available in serverless env. ` + `Skipping ${orgName} (${rfpUrl}). ` + `To enable: integrate BrowserBase or ScrapingBee API.`);
        return [];
    }
}
class RfpScraper {
    staticScraper = new StaticScraper();
    dynamicScraper = new DynamicScraperStub();
    async run() {
        const supabase = getAdminClient();
        const results = [];
        // 1. 수집 활성화된 기관 목록 조회
        const { data: orgs, error: orgsErr } = await supabase.from("rfp_public_org").select("id, org_name, org_type, homepage_url, rfp_url, coll_meth, is_active").eq("is_active", true);
        if (orgsErr) {
            console.error("[RfpScraper] Failed to fetch orgs:", orgsErr.message);
            return [
                {
                    org_id: 0,
                    org_name: "N/A",
                    status: "error",
                    inserted: 0,
                    skipped: 0,
                    error: orgsErr.message
                }
            ];
        }
        if (!orgs || orgs.length === 0) {
            console.log("[RfpScraper] No active orgs found.");
            return [];
        }
        console.log(`[RfpScraper] Processing ${orgs.length} active orgs`);
        // 2. 기관별 수집
        for (const org of orgs){
            const result = await this.scrapeOrg(supabase, org);
            results.push(result);
            console.log(`[RfpScraper] ${org.org_name}: ${result.status} ` + `(inserted=${result.inserted}, skipped=${result.skipped})`);
        }
        return results;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    async scrapeOrg(supabase, org) {
        const base = {
            org_id: org.id,
            org_name: org.org_name,
            status: "success",
            inserted: 0,
            skipped: 0
        };
        if (!org.rfp_url) {
            return {
                ...base,
                status: "skipped",
                error: "rfp_url 없음"
            };
        }
        // 3. 엔진 분기
        let announcements = [];
        try {
            if (org.coll_meth === "Dynamic Scraper") {
                announcements = await this.dynamicScraper.scrape(org.rfp_url, org.org_name);
            } else {
                // Static Scraper, RSS, API 모두 Cheerio 기반 처리
                announcements = await this.staticScraper.scrape(org.rfp_url);
            }
        } catch (err) {
            return {
                ...base,
                status: "error",
                error: err.message
            };
        }
        if (announcements.length === 0) {
            return {
                ...base,
                status: "skipped",
                error: "공고 없음 (파싱 결과 0건)"
            };
        }
        // 4. 증분 저장 (unique_key 기준 upsert → 신규만 INSERT)
        let inserted = 0;
        let skipped = 0;
        for (const ann of announcements){
            if (!ann.title?.trim()) continue;
            const unique_key = buildUniqueKey(org.id, ann.title, ann.deadline);
            const row = {
                org_id: org.id,
                unique_key,
                title: ann.title.trim(),
                category: ann.category ?? org.org_type ?? null,
                deadline: ann.deadline ?? null,
                description: ann.description ?? null,
                source_url: ann.source_url ?? null,
                is_active: true,
                scraped_at: new Date().toISOString()
            };
            // 증분 수집: unique_key 중복 여부 먼저 확인
            const { data: existing } = await supabase.from("rfp_announcements").select("id").eq("unique_key", unique_key).maybeSingle();
            if (existing) {
                skipped++; // 이미 존재 → skip
                continue;
            }
            const { error: insertErr } = await supabase.from("rfp_announcements").insert(row);
            if (insertErr) {
                console.error(`[RfpScraper] Insert error for "${ann.title}":`, insertErr.message);
            } else {
                inserted++;
            }
        }
        return {
            ...base,
            inserted,
            skipped
        };
    }
}
}),
"[project]/src/app/api/cron/rfp-scrape/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "dynamic",
    ()=>dynamic,
    "maxDuration",
    ()=>maxDuration
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$services$2f$rfp$2d$scraper$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/services/rfp-scraper.ts [app-route] (ecmascript)");
;
;
const dynamic = "force-dynamic";
const maxDuration = 300; // Vercel Pro: 최대 5분 실행 허용
async function GET(request) {
    // ── 보안: CRON_SECRET 검증 ─────────────────────────────────────────────
    const authHeader = request.headers.get("authorization");
    const cronSecret = process.env.CRON_SECRET;
    if (cronSecret && authHeader !== `Bearer ${cronSecret}`) {
        console.warn("[rfp-scrape] Unauthorized cron request");
        return new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"]("Unauthorized", {
            status: 401
        });
    }
    const startedAt = new Date().toISOString();
    console.log(`[rfp-scrape] Cron started at ${startedAt}`);
    try {
        const scraper = new __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$services$2f$rfp$2d$scraper$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["RfpScraper"]();
        const results = await scraper.run();
        const totalInserted = results.reduce((s, r)=>s + r.inserted, 0);
        const totalSkipped = results.reduce((s, r)=>s + r.skipped, 0);
        const errors = results.filter((r)=>r.status === "error");
        console.log(`[rfp-scrape] Done. inserted=${totalInserted}, skipped=${totalSkipped}, errors=${errors.length}`);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            startedAt,
            completedAt: new Date().toISOString(),
            summary: {
                totalOrgs: results.length,
                totalInserted,
                totalSkipped,
                totalErrors: errors.length
            },
            results
        });
    } catch (err) {
        console.error("[rfp-scrape] Fatal error:", err);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: false,
            error: err.message,
            startedAt
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__fdcb4d8a._.js.map